<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡ç”Ÿæˆ - AI å›¾ç‰‡ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .nav-bar {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .nav-bar a {
            color: #667eea;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .nav-bar a:hover {
            background: #667eea;
            color: white;
        }
        
        .nav-bar a.active {
            background: #667eea;
            color: white;
        }
        
        .user-info {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #666;
            font-weight: 500;
        }
        
        .user-info .username {
            color: #667eea;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white !important;
            padding: 6px 14px !important;
            font-size: 0.9em;
        }
        
        .logout-btn:hover {
            background: #c82333 !important;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .import-area {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 0.9em;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .batch-table-container {
            overflow-x: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .batch-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        .batch-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
        }
        
        .batch-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .batch-table input,
        .batch-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .batch-table textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9em;
            resize: vertical;
            min-height: 60px;
        }
        
        .ref-images-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.85em;
            margin-bottom: 5px;
        }
        
        .ref-images-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .sample-select-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            width: 100%;
        }
        
        .sample-select-btn:hover {
            background: #5568d3;
        }
        
        .selected-samples {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        
        .selected-sample-tag {
            background: #e7f3ff;
            color: #0066cc;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .selected-sample-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .sample-item {
            position: relative;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .sample-item:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .sample-item.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px #667eea;
        }
        
        .sample-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        
        .sample-check {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .sample-item.selected .sample-check {
            display: flex;
        }
        
        .progress-area {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .progress-area.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .progress-log {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .progress-log div {
            margin-bottom: 5px;
        }
        
        .progress-log .success {
            color: #28a745;
        }
        
        .progress-log .error {
            color: #dc3545;
        }
        
        .progress-log .info {
            color: #17a2b8;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .file-input-label:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <a href="/">ğŸ¨ å•å›¾ç”Ÿæˆ</a>
        <a href="/batch" class="active">ğŸ“¦ æ‰¹é‡ç”Ÿæˆ</a>
        <a href="/records">ğŸ“Š ç”Ÿæˆè®°å½•</a>
        <a href="/script-analysis">ğŸ¬ å‰§æœ¬åˆ†æ</a>
        <a href="/manage-samples">ğŸ–¼ï¸ ç´ æç®¡ç†</a>
        {% if user.username == 'system_admin' %}
        <a href="/stats">ğŸ“ˆ ç³»ç»Ÿç»Ÿè®¡</a>
        {% endif %}
        <div class="user-info">
            <span>ğŸ‘¤ <span class="username">{{ user.username }}</span></span>
            <a href="/logout" class="logout-btn">ç™»å‡º</a>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ“¦ æ‰¹é‡å›¾ç‰‡ç”Ÿæˆ</h1>
            <p>å¯¼å…¥Excelæˆ–æ‰‹åŠ¨æ·»åŠ ï¼Œæ‰¹é‡ç”ŸæˆAIå›¾ç‰‡</p>
        </div>
        
        <div class="content">
            <!-- å¯¼å…¥/å¯¼å‡ºåŒºåŸŸ -->
            <div class="section">
                <div class="section-title">ğŸ“¥ å¯¼å…¥/å¯¼å‡º</div>
                <div class="import-area">
                    <label for="excelFile" class="file-input-label">ğŸ“‚ å¯¼å…¥ Excel</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="importExcel(event)">
                    
                    <button class="btn btn-secondary" onclick="downloadTemplate()">
                        ğŸ“„ ä¸‹è½½æ¨¡æ¿
                    </button>
                    
                    <button class="btn btn-secondary" onclick="exportToExcel()">
                        ğŸ’¾ å¯¼å‡ºå½“å‰è¡¨æ ¼
                    </button>
                </div>
            </div>
            
            <!-- æ‰¹é‡è¡¨æ ¼ -->
            <div class="section">
                <div class="section-title">ğŸ“ æ‰¹é‡ä»»åŠ¡åˆ—è¡¨</div>
                <button class="btn btn-success" onclick="addRow()" style="margin-bottom: 15px;">
                    â• æ·»åŠ ä¸€è¡Œ
                </button>
                
                <div class="batch-table-container">
                    <table class="batch-table" id="batchTable">
                        <thead>
                            <tr>
                                <th style="width: 60px;">åºå·</th>
                                <th style="width: 250px;">æç¤ºè¯ *</th>
                                <th style="width: 150px;">è´Ÿé¢æç¤ºè¯</th>
                                <th style="width: 120px;">å›¾ç‰‡æ¯”ä¾‹</th>
                                <th style="width: 100px;">åˆ†è¾¨ç‡</th>
                                <th style="width: 200px;">å‚è€ƒå›¾</th>
                                <th style="width: 100px;">ç”Ÿæˆæ•°é‡</th>
                                <th style="width: 120px;">æ–‡ä»¶å</th>
                                <th style="width: 80px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="batchTableBody">
                            <!-- åŠ¨æ€æ·»åŠ è¡Œ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ç”ŸæˆæŒ‰é’® -->
            <div class="section">
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="backgroundMode" checked>
                        <span>åå°æ¨¡å¼ï¼ˆæ¨èï¼Œå¯åˆ‡æ¢é¡µé¢ï¼‰</span>
                    </label>
                    <span style="color: #666; font-size: 0.9em;">
                        ğŸ’¡ åå°æ¨¡å¼ä¸‹ï¼Œä»»åŠ¡æäº¤ååœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼Œä¸å—é¡µé¢åˆ‡æ¢å½±å“
                    </span>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="startBatchGeneration()" style="width: 100%; font-size: 1.2em;">
                        ğŸš€ å¼€å§‹æ‰¹é‡ç”Ÿæˆ
                    </button>
                </div>
            </div>
            
            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div class="progress-area" id="progressArea">
                <h3>ç”Ÿæˆè¿›åº¦</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                </div>
                <div class="progress-log" id="progressLog"></div>
            </div>
        </div>
    </div>
    
    <!-- ç¤ºä¾‹å›¾é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal" id="sampleModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeSampleModal()">&times;</span>
            <div style="display:flex; align-items:center; gap:12px;">
                <h2>é€‰æ‹©å‚è€ƒç¤ºä¾‹å›¾</h2>
                <div style="margin-left:auto; display:flex; gap:8px;">
                    <button type="button" id="batchPersonBtn" class="btn btn-sm btn-primary">äººç‰©åº“</button>
                    <button type="button" id="batchSceneBtn" class="btn btn-sm">åœºæ™¯åº“</button>
                </div>
            </div>
            <p style="color: #666; margin-top: 10px;">ç‚¹å‡»å›¾ç‰‡é€‰æ‹©ï¼ˆæœ€å¤š4å¼ ï¼‰</p>
            <div class="sample-grid" id="modalSampleGrid">
                <!-- åŠ¨æ€åŠ è½½ç¤ºä¾‹å›¾ -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="confirmSampleSelection()">
                    âœ“ ç¡®è®¤é€‰æ‹©
                </button>
            </div>
        </div>
    </div>
    
    <script>
        let batchData = [];
        let sampleImages = [];
        let currentRowIndex = -1;
        let selectedSamplesForRow = [];
        // æ‰¹é‡æ¨¡æ€ç¤ºä¾‹å›¾ç±»åˆ«ï¼ˆperson/sceneï¼‰
        let batchSampleCategory = 'person';
        
        // ä¿å­˜æ‰¹é‡æ•°æ®åˆ°localStorage
        function saveBatchData() {
            try {
                localStorage.setItem('batchData', JSON.stringify(batchData));
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
            }
        }
        
        // ä» localStorage æ¢å¤æ•°æ®
        function loadBatchData() {
            try {
                const saved = localStorage.getItem('batchData');
                if (saved) {
                    batchData = JSON.parse(saved);
                    if (batchData.length > 0) {
                        renderTable();
                        return true;
                    }
                }
            } catch (e) {
                console.error('æ¢å¤æ•°æ®å¤±è´¥:', e);
            }
            return false;
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ‰¹é‡æ¨¡æ€ç±»åˆ«æŒ‰é’®
            const btnP = document.getElementById('batchPersonBtn');
            const btnS = document.getElementById('batchSceneBtn');
            if (btnP && btnS) {
                btnP.addEventListener('click', () => switchBatchSampleCategory('person'));
                btnS.addEventListener('click', () => switchBatchSampleCategory('scene'));
            }
            // é»˜è®¤æŒ‰ person åŠ è½½
            loadSampleImages(batchSampleCategory);

            // å°è¯•æ¢å¤ä¿å­˜çš„æ•°æ®
            if (!loadBatchData()) {
                addRow(); // é»˜è®¤æ·»åŠ ä¸€è¡Œ
            }
            // (ä¿æŒåŸæœ‰è¡Œä¸ºï¼šä¸è‡ªåŠ¨æ¸…é™¤æ‰¹é‡ç¼“å­˜)
        });
        
        // åŠ è½½ç¤ºä¾‹å›¾ï¼ˆæŒ‰ç±»åˆ«ï¼‰
        async function loadSampleImages(category) {
            try {
                const response = await fetch('/api/sample-images?category=' + encodeURIComponent(category));
                const data = await response.json();
                if (data.success) {
                    sampleImages = data.images;
                } else {
                    sampleImages = [];
                }
            } catch (error) {
                console.error('åŠ è½½ç¤ºä¾‹å›¾å¤±è´¥:', error);
                sampleImages = [];
            }
        }

        async function switchBatchSampleCategory(cat) {
            batchSampleCategory = cat;
            const btnP = document.getElementById('batchPersonBtn');
            const btnS = document.getElementById('batchSceneBtn');
            if (btnP && btnS) {
                btnP.classList.toggle('btn-primary', cat === 'person');
                btnS.classList.toggle('btn-primary', cat === 'scene');
            }
            await loadSampleImages(cat);

            // å¦‚æœæ¨¡æ€å·²æ‰“å¼€ï¼Œå®æ—¶åˆ·æ–°æ¨¡æ€å†…çš„ç¤ºä¾‹å›¾
            const modal = document.getElementById('sampleModal');
            if (modal && modal.classList.contains('active')) {
                renderModalSampleGrid();
            }
        }

        // åœ¨æ¨¡æ€ä¸­æ¸²æŸ“ sampleImages
        function renderModalSampleGrid() {
            const grid = document.getElementById('modalSampleGrid');
            if (!grid) return;
            grid.innerHTML = '';
            sampleImages.forEach((img, index) => {
                const isSelected = selectedSamplesForRow.some(s => s.url === img.url);
                const div = document.createElement('div');
                div.className = `sample-item ${isSelected ? 'selected' : ''}`;
                div.onclick = () => toggleSampleInModal(index);
                div.innerHTML = `
                    <img src="${img.url}" alt="${img.filename}">
                    <div class="sample-check">âœ“</div>
                `;
                grid.appendChild(div);
            });
        }
        
        // æ·»åŠ è¡Œ
        function addRow() {
            const rowIndex = batchData.length;
            batchData.push({
                prompt: '',
                negative_prompt: '',
                aspect_ratio: '1:1',
                resolution: '2k',
                ref_images_text: '',
                sample_images: [],
                num_images: 1,
                filename: `batch_${rowIndex + 1}`
            });
            
            saveBatchData();
            renderTable();
        }
        
        // åˆ é™¤è¡Œ
        function deleteRow(index) {
            if (confirm('ç¡®å®šåˆ é™¤è¿™ä¸€è¡Œå—ï¼Ÿ')) {
                batchData.splice(index, 1);
                saveBatchData();
                renderTable();
            }
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('batchTableBody');
            tbody.innerHTML = '';
            
            batchData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <textarea onchange="updateRow(${index}, 'prompt', this.value)"
                                  placeholder="æè¿°ä½ æƒ³è¦çš„å›¾ç‰‡...">${row.prompt}</textarea>
                    </td>
                    <td>
                        <textarea onchange="updateRow(${index}, 'negative_prompt', this.value)"
                                  placeholder="ä¸æƒ³è¦çš„å†…å®¹...">${row.negative_prompt}</textarea>
                    </td>
                    <td>
                        <select onchange="updateRow(${index}, 'aspect_ratio', this.value)">
                            <option value="1:1" ${row.aspect_ratio === '1:1' ? 'selected' : ''}>1:1</option>
                            <option value="2:3" ${row.aspect_ratio === '2:3' ? 'selected' : ''}>2:3</option>
                            <option value="3:2" ${row.aspect_ratio === '3:2' ? 'selected' : ''}>3:2</option>
                            <option value="3:4" ${row.aspect_ratio === '3:4' ? 'selected' : ''}>3:4</option>
                            <option value="4:3" ${row.aspect_ratio === '4:3' ? 'selected' : ''}>4:3</option>
                            <option value="16:9" ${row.aspect_ratio === '16:9' ? 'selected' : ''}>16:9</option>
                            <option value="9:16" ${row.aspect_ratio === '9:16' ? 'selected' : ''}>9:16</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateRow(${index}, 'resolution', this.value)">
                            <option value="1k" ${row.resolution === '1k' ? 'selected' : ''}>1K</option>
                            <option value="2k" ${row.resolution === '2k' ? 'selected' : ''}>2K</option>
                            <option value="4k" ${row.resolution === '4k' ? 'selected' : ''}>4K</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" class="ref-images-input" 
                               placeholder="è¾“å…¥æ–‡ä»¶åï¼Œé€—å·åˆ†éš”" 
                               value="${row.ref_images_text || ''}"
                               onchange="updateRefImages(${index}, this.value)">
                        <button class="sample-select-btn" onclick="openSampleModal(${index})">
                            é€‰æ‹© (${row.sample_images.length})
                        </button>
                        <div class="selected-samples" id="samples_${index}">
                            ${renderSelectedSamples(row.sample_images, index)}
                        </div>
                    </td>
                    <td>
                        <input type="number" value="${row.num_images}" min="1" max="10"
                               onchange="updateRow(${index}, 'num_images', parseInt(this.value))">
                    </td>
                    <td>
                        <input type="text" value="${row.filename}"
                               onchange="updateRow(${index}, 'filename', this.value)"
                               placeholder="æ–‡ä»¶å">
                    </td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRow(${index})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // æ¸²æŸ“å·²é€‰ç¤ºä¾‹å›¾æ ‡ç­¾
        function renderSelectedSamples(samples, rowIndex) {
            return samples.map((sample, idx) => `
                <span class="selected-sample-tag">
                    ${sample.filename.substring(0, 10)}...
                    <span class="remove" onclick="removeSampleFromRow(${rowIndex}, ${idx})">Ã—</span>
                </span>
            `).join('');
        }
        
        // æ›´æ–°è¡Œæ•°æ®
        function updateRow(index, field, value) {
            batchData[index][field] = value;
            saveBatchData();
        }
        
        // ä»è¡Œä¸­ç§»é™¤ç¤ºä¾‹å›¾
        function removeSampleFromRow(rowIndex, sampleIndex) {
            batchData[rowIndex].sample_images.splice(sampleIndex, 1);
            // æ›´æ–°æ–‡æœ¬è¾“å…¥æ¡†
            batchData[rowIndex].ref_images_text = batchData[rowIndex].sample_images
                .map(img => img.filename.split('.')[0])
                .join(', ');
            saveBatchData();
            renderTable();
        }
        
        // æ›´æ–°å‚è€ƒå›¾ï¼ˆé€šè¿‡æ–‡æœ¬è¾“å…¥ï¼‰
        function updateRefImages(rowIndex, text) {
            batchData[rowIndex].ref_images_text = text;
            
            // è‡ªåŠ¨åŒ¹é…ç¤ºä¾‹å›¾
            const matchedSamples = [];
            if (text && text.trim()) {
                // æ”¯æŒé€—å·ã€åˆ†å·ã€ç©ºæ ¼åˆ†éš”
                const filenames = text.split(/[,ï¼Œ;\s]+/).filter(f => f.trim());
                
                filenames.forEach(name => {
                    const trimmedName = name.trim();
                    // åœ¨ç¤ºä¾‹å›¾ä¸­åŒ¹é…æ–‡ä»¶åï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                    const matched = sampleImages.find(img => 
                        img.filename.includes(trimmedName) || 
                        trimmedName.includes(img.filename.split('.')[0])
                    );
                    if (matched && !matchedSamples.find(m => m.url === matched.url) && matchedSamples.length < 4) {
                        matchedSamples.push(matched);
                    }
                });
            }
            
            batchData[rowIndex].sample_images = matchedSamples;
            saveBatchData();
            renderTable();
        }
        
        // æ‰“å¼€ç¤ºä¾‹å›¾é€‰æ‹©æ¨¡æ€æ¡†
        function openSampleModal(rowIndex) {
            currentRowIndex = rowIndex;
            selectedSamplesForRow = [...batchData[rowIndex].sample_images];
            
            const grid = document.getElementById('modalSampleGrid');
            grid.innerHTML = '';
            
            sampleImages.forEach((img, index) => {
                const isSelected = selectedSamplesForRow.some(s => s.url === img.url);
                const div = document.createElement('div');
                div.className = `sample-item ${isSelected ? 'selected' : ''}`;
                div.onclick = () => toggleSampleInModal(index);
                div.innerHTML = `
                    <img src="${img.url}" alt="${img.filename}">
                    <div class="sample-check">âœ“</div>
                `;
                grid.appendChild(div);
            });
            
            document.getElementById('sampleModal').classList.add('active');
        }
        
        // åˆ‡æ¢ç¤ºä¾‹å›¾é€‰æ‹©
        function toggleSampleInModal(index) {
            const img = sampleImages[index];
            const existingIndex = selectedSamplesForRow.findIndex(s => s.url === img.url);
            
            if (existingIndex >= 0) {
                selectedSamplesForRow.splice(existingIndex, 1);
            } else {
                if (selectedSamplesForRow.length >= 4) {
                    alert('æœ€å¤šé€‰æ‹©4å¼ ç¤ºä¾‹å›¾');
                    return;
                }
                selectedSamplesForRow.push(img);
            }
            
            // æ›´æ–°UI
            const items = document.querySelectorAll('#modalSampleGrid .sample-item');
            items[index].classList.toggle('selected');
        }
        
        // ç¡®è®¤ç¤ºä¾‹å›¾é€‰æ‹©
        function confirmSampleSelection() {
            batchData[currentRowIndex].sample_images = [...selectedSamplesForRow];
            // åŒæ­¥æ›´æ–°æ–‡æœ¬è¾“å…¥æ¡†
            batchData[currentRowIndex].ref_images_text = selectedSamplesForRow
                .map(img => img.filename.split('.')[0])
                .join(', ');
            saveBatchData();
            closeSampleModal();
            renderTable();
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeSampleModal() {
            document.getElementById('sampleModal').classList.remove('active');
            currentRowIndex = -1;
            selectedSamplesForRow = [];
        }
        
        // å¯¼å…¥Excel
        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);
                
                batchData = rows.map(row => {
                    // è§£æå‚è€ƒå›¾æ–‡ä»¶åï¼ˆå…¼å®¹æ—§çš„"ç¤ºä¾‹å›¾æ–‡ä»¶å"åˆ—ï¼‰
                    const sampleFilenames = row['å‚è€ƒå›¾'] || row['ç¤ºä¾‹å›¾æ–‡ä»¶å'] || '';
                    const matchedSamples = [];
                    
                    if (sampleFilenames && sampleFilenames.trim()) {
                        // æ”¯æŒé€—å·ã€ä¸­æ–‡é€—å·ã€åˆ†å·ã€ç©ºæ ¼åˆ†éš”
                        const filenames = sampleFilenames.split(/[,ï¼Œ;\s]+/).filter(f => f.trim());
                        
                        filenames.forEach(name => {
                            const trimmedName = name.trim();
                            // åœ¨ç¤ºä¾‹å›¾ä¸­åŒ¹é…æ–‡ä»¶åï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                            const matched = sampleImages.find(img => 
                                img.filename.includes(trimmedName) || 
                                trimmedName.includes(img.filename.split('.')[0])
                            );
                            if (matched && !matchedSamples.find(m => m.url === matched.url) && matchedSamples.length < 4) {
                                matchedSamples.push(matched);
                            }
                        });
                    }
                    
                    // å¤„ç†å›¾ç‰‡æ¯”ä¾‹ï¼ˆExcelå¯èƒ½å°†1:1è§£æä¸ºæ•°å­—1ï¼‰
                    let aspectRatio = row['å›¾ç‰‡æ¯”ä¾‹'] || '1:1';
                    if (typeof aspectRatio === 'number') {
                        // å¦‚æœæ˜¯æ•°å­—ï¼Œè½¬æ¢å›æ¯”ä¾‹æ ¼å¼
                        if (aspectRatio === 1) aspectRatio = '1:1';
                        else if (Math.abs(aspectRatio - 0.6667) < 0.01) aspectRatio = '2:3';
                        else if (Math.abs(aspectRatio - 1.5) < 0.01) aspectRatio = '3:2';
                        else if (Math.abs(aspectRatio - 0.75) < 0.01) aspectRatio = '3:4';
                        else if (Math.abs(aspectRatio - 1.3333) < 0.01) aspectRatio = '4:3';
                        else if (Math.abs(aspectRatio - 1.7778) < 0.01) aspectRatio = '16:9';
                        else if (Math.abs(aspectRatio - 0.5625) < 0.01) aspectRatio = '9:16';
                        else aspectRatio = '1:1'; // é»˜è®¤å€¼
                    }
                    
                    return {
                        prompt: row['æç¤ºè¯'] || '',
                        negative_prompt: row['è´Ÿé¢æç¤ºè¯'] || '',
                        aspect_ratio: String(aspectRatio),
                        resolution: row['åˆ†è¾¨ç‡'] || '2k',
                        ref_images_text: row['å‚è€ƒå›¾'] || row['ç¤ºä¾‹å›¾æ–‡ä»¶å'] || '',
                        sample_images: matchedSamples,
                        num_images: row['ç”Ÿæˆæ•°é‡'] || 1,
                        filename: row['æ–‡ä»¶å'] || 'generated'
                    };
                });
                
                saveBatchData(); // ä¿å­˜åˆ°localStorage
                renderTable();
                
                const totalMatched = batchData.reduce((sum, row) => sum + row.sample_images.length, 0);
                alert(`æˆåŠŸå¯¼å…¥ ${batchData.length} è¡Œæ•°æ®ï¼ŒåŒ¹é… ${totalMatched} ä¸ªç¤ºä¾‹å›¾`);
            };
            reader.readAsArrayBuffer(file);
        }
        
        // ä¸‹è½½æ¨¡æ¿
        function downloadTemplate() {
            const template = [
                {
                    'æç¤ºè¯': 'ä¸€åªå¯çˆ±çš„çŒ«å’ª',
                    'è´Ÿé¢æç¤ºè¯': 'æ¨¡ç³Šï¼Œä½è´¨é‡',
                    'å›¾ç‰‡æ¯”ä¾‹': '1:1',
                    'åˆ†è¾¨ç‡': '2k',
                    'å‚è€ƒå›¾': 'sdk_generated_20251130, example_image',
                    'ç”Ÿæˆæ•°é‡': 1,
                    'æ–‡ä»¶å': 'cat_01'
                },
                {
                    'æç¤ºè¯': 'ç¾ä¸½çš„é£æ™¯ç”»',
                    'è´Ÿé¢æç¤ºè¯': '',
                    'å›¾ç‰‡æ¯”ä¾‹': '16:9',
                    'åˆ†è¾¨ç‡': '2k',
                    'å‚è€ƒå›¾': '',
                    'ç”Ÿæˆæ•°é‡': 2,
                    'æ–‡ä»¶å': 'landscape_01'
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ‰¹é‡ç”Ÿæˆæ¨¡æ¿');
            XLSX.writeFile(wb, 'æ‰¹é‡ç”Ÿæˆæ¨¡æ¿.xlsx');
        }
        
        // å¯¼å‡ºåˆ°Excel
        function exportToExcel() {
            const exportData = batchData.map((row, index) => ({
                'åºå·': index + 1,
                'æç¤ºè¯': row.prompt,
                'è´Ÿé¢æç¤ºè¯': row.negative_prompt,
                'å›¾ç‰‡æ¯”ä¾‹': row.aspect_ratio,
                'åˆ†è¾¨ç‡': row.resolution,
                'å‚è€ƒå›¾': row.ref_images_text || row.sample_images.map(img => img.filename.split('.')[0]).join(', '),
                'ç”Ÿæˆæ•°é‡': row.num_images,
                'æ–‡ä»¶å': row.filename
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ‰¹é‡ä»»åŠ¡');
            XLSX.writeFile(wb, `æ‰¹é‡ä»»åŠ¡_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        
        // æ‰¹é‡ç”ŸæˆçŠ¶æ€
        let isGenerating = false;
        let generationStartTime = null;
        let generationLogs = [];
        let currentBatchId = null;
        let progressPollingInterval = null;
        
        // è·å–å½“å‰ç”¨æˆ·åï¼ˆä»é¡µé¢ä¸­è·å–ï¼‰
        function getCurrentUsername() {
            const usernameElement = document.querySelector('.username');
            return usernameElement ? usernameElement.textContent.trim() : null;
        }
        
        // æ¢å¤æ‰¹é‡ä»»åŠ¡çŠ¶æ€çš„å‡½æ•°
        function restoreBatchState() {
            const savedBatchId = localStorage.getItem('currentBatchId');
            const savedProgress = localStorage.getItem('batchProgress');
            const savedLogs = localStorage.getItem('batchLogs');
            const savedBatchUsername = localStorage.getItem('batchUsername');
            const currentUsername = getCurrentUsername();
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åŒ¹é…
            if (savedBatchUsername && savedBatchUsername !== currentUsername) {
                console.log('æ£€æµ‹åˆ°ä¸åŒç”¨æˆ·çš„æ‰¹é‡ä»»åŠ¡çŠ¶æ€ï¼Œæ¸…é™¤æ—§çŠ¶æ€');
                localStorage.removeItem('currentBatchId');
                localStorage.removeItem('batchProgress');
                localStorage.removeItem('batchLogs');
                localStorage.removeItem('batchUsername');
                return false;
            }
            
            // æ¢å¤æ—¥å¿—
            if (savedLogs) {
                try {
                    generationLogs = JSON.parse(savedLogs);
                    const progressLog = document.getElementById('progressLog');
                    if (progressLog) {
                        progressLog.innerHTML = '';
                        generationLogs.forEach(log => {
                            const logDiv = document.createElement('div');
                            logDiv.className = 'log-' + log.type;
                            logDiv.textContent = log.message;
                            progressLog.appendChild(logDiv);
                        });
                        
                        // å¦‚æœæœ‰æ—¥å¿—ï¼Œæ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
                        if (generationLogs.length > 0) {
                            document.getElementById('progressArea').classList.add('active');
                        }
                    }
                } catch (e) {
                    console.error('æ¢å¤æ—¥å¿—å¤±è´¥:', e);
                }
            }
            
            // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„æ‰¹æ¬¡IDï¼Œæ¢å¤è½®è¯¢
            if (savedBatchId) {
                currentBatchId = savedBatchId;
                isGenerating = true;
                
                if (savedProgress) {
                    try {
                        const data = JSON.parse(savedProgress);
                        generationStartTime = data.startTime;
                    } catch (e) {
                        generationStartTime = Date.now();
                    }
                } else {
                    generationStartTime = Date.now();
                }
                
                const progressArea = document.getElementById('progressArea');
                if (progressArea) {
                    progressArea.classList.add('active');
                    addLog('ğŸ”„ æ£€æµ‹åˆ°åå°ä»»åŠ¡ï¼Œæ¢å¤è¿›åº¦è½®è¯¢...', 'info');
                    
                    // ç«‹å³æŸ¥è¯¢ä¸€æ¬¡è¿›åº¦
                    fetch(`/api/batch-progress/${currentBatchId}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                const progress = data.progress;
                                const total = progress.total;
                                
                                // å¦‚æœä»»åŠ¡è¿˜åœ¨è¿›è¡Œä¸­ï¼Œæ¢å¤è½®è¯¢
                                if (progress.status === 'running') {
                                    startProgressPolling(currentBatchId, total);
                                    console.log('å·²æ¢å¤æ‰¹é‡ç”Ÿæˆä»»åŠ¡:', currentBatchId);
                                } else {
                                    // ä»»åŠ¡å·²å®Œæˆ
                                    isGenerating = false;
                                    addLog(`âœ… ä»»åŠ¡å·²å®Œæˆï¼ŒæˆåŠŸ: ${progress.completed}, å¤±è´¥: ${progress.failed}`, 'success');
                                }
                            } else {
                                // æ‰¹æ¬¡ä¸å­˜åœ¨ï¼Œæ¸…ç†
                                localStorage.removeItem('currentBatchId');
                                localStorage.removeItem('batchProgress');
                                localStorage.removeItem('batchUsername');
                                isGenerating = false;
                                addLog('âš ï¸ æ‰¹æ¬¡ä»»åŠ¡ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('æŸ¥è¯¢è¿›åº¦å¤±è´¥:', error);
                            addLog('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                        });
                }
                return true;
            }
            
            // å¤„ç†æ—§ç‰ˆæœ¬æ•°æ®ï¼ˆæ²¡æœ‰æ‰¹æ¬¡IDï¼‰
            if (savedProgress && !savedBatchId) {
                try {
                    const data = JSON.parse(savedProgress);
                    const elapsed = Math.round((Date.now() - data.startTime) / 1000);
                    
                    // å¦‚æœæ˜¯è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼ˆ1å°æ—¶å†…ï¼‰ä½†æ²¡æœ‰æ‰¹æ¬¡IDï¼ˆæ—§ç‰ˆæœ¬ï¼‰
                    if (data.completed < data.total && elapsed < 3600) {
                        isGenerating = true;
                        generationStartTime = data.startTime;
                        const progressArea = document.getElementById('progressArea');
                        if (progressArea) {
                            progressArea.classList.add('active');
                            const percent = Math.round((data.completed / data.total) * 100);
                            const progressFill = document.getElementById('progressFill');
                            if (progressFill) {
                                progressFill.style.width = percent + '%';
                                progressFill.textContent = percent + '%';
                            }
                            addLog(`é¡µé¢å·²è¿”å›ï¼Œå½“å‰è¿›åº¦: ${data.completed}/${data.total} (${percent}%)`, 'info');
                        }
                        return true;
                    }
                } catch (e) {
                    console.error('æ¢å¤è¿›åº¦å¤±è´¥:', e);
                }
            }
            
            return false;
        }
        
        // é¡µé¢åŠ è½½æ—¶ï¼Œå…ˆæ£€æŸ¥å¹¶æ¸…é™¤ä¸åŒ¹é…ç”¨æˆ·çš„æ‰¹é‡ä»»åŠ¡çŠ¶æ€
        window.addEventListener('load', function() {
            const currentUsername = getCurrentUsername();
            const savedBatchUsername = localStorage.getItem('batchUsername');
            
            // å¦‚æœä¿å­˜çš„çŠ¶æ€å±äºå…¶ä»–ç”¨æˆ·ï¼Œæ¸…é™¤å®ƒ
            if (savedBatchUsername && savedBatchUsername !== currentUsername) {
                console.log('æ£€æµ‹åˆ°ä¸åŒç”¨æˆ·çš„æ‰¹é‡ä»»åŠ¡çŠ¶æ€ï¼Œæ¸…é™¤æ—§çŠ¶æ€');
                localStorage.removeItem('currentBatchId');
                localStorage.removeItem('batchProgress');
                localStorage.removeItem('batchLogs');
                localStorage.removeItem('batchUsername');
            }
            
            // ç„¶åæ¢å¤ä»»åŠ¡çŠ¶æ€
            restoreBatchState();
        });
        
        // ä½¿ç”¨ pageshow äº‹ä»¶ç¡®ä¿ä»ç¼“å­˜æ¢å¤æ—¶ä¹Ÿèƒ½æ¢å¤çŠ¶æ€
        window.addEventListener('pageshow', function(event) {
            // event.persisted ä¸º true è¡¨ç¤ºé¡µé¢æ˜¯ä»ç¼“å­˜ä¸­æ¢å¤çš„
            if (event.persisted) {
                console.log('é¡µé¢ä»ç¼“å­˜æ¢å¤ï¼Œæ£€æŸ¥æ‰¹é‡ä»»åŠ¡çŠ¶æ€...');
                restoreBatchState();
            }
        });
        
        // é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€
        window.addEventListener('beforeunload', function() {
            if (isGenerating && currentBatchId) {
                const currentUsername = getCurrentUsername();
                localStorage.setItem('currentBatchId', currentBatchId);
                localStorage.setItem('batchUsername', currentUsername);
                localStorage.setItem('batchProgress', JSON.stringify({
                    completed: 0,
                    total: 0,
                    startTime: generationStartTime
                }));
            }
        });
        
        // ç›‘å¬æ‰€æœ‰å¯¼èˆªäº‹ä»¶ï¼Œåœ¨åˆ‡æ¢å‰ä¿å­˜çŠ¶æ€
        document.addEventListener('click', function(e) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å¯¼èˆªé“¾æ¥
            const link = e.target.closest('a');
            if (link && link.href && !link.href.startsWith('javascript:') && !link.href.startsWith('#')) {
                // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿çŠ¶æ€å·²æ›´æ–°
                setTimeout(() => {
                    if (isGenerating && currentBatchId) {
                        const currentUsername = getCurrentUsername();
                        localStorage.setItem('currentBatchId', currentBatchId);
                        localStorage.setItem('batchUsername', currentUsername);
                        if (generationStartTime) {
                            localStorage.setItem('batchProgress', JSON.stringify({
                                completed: 0,
                                total: 0,
                                startTime: generationStartTime
                            }));
                        }
                    }
                }, 100);
            }
        });
        
        // å®šæœŸä¿å­˜æ‰¹é‡ä»»åŠ¡çŠ¶æ€ï¼ˆæ¯5ç§’ï¼‰ï¼Œé˜²æ­¢çŠ¶æ€ä¸¢å¤±
        setInterval(function() {
            if (isGenerating && currentBatchId) {
                const currentUsername = getCurrentUsername();
                localStorage.setItem('currentBatchId', currentBatchId);
                localStorage.setItem('batchUsername', currentUsername);
                if (generationStartTime) {
                    localStorage.setItem('batchProgress', JSON.stringify({
                        completed: 0,
                        total: 0,
                        startTime: generationStartTime
                    }));
                }
            }
        }, 5000);
        
        // å¼€å§‹æ‰¹é‡ç”Ÿæˆ
        async function startBatchGeneration() {
            // éªŒè¯æ•°æ®
            if (batchData.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€è¡Œä»»åŠ¡');
                return;
            }
            
            for (let i = 0; i < batchData.length; i++) {
                if (!batchData[i].prompt.trim()) {
                    alert(`ç¬¬ ${i + 1} è¡Œç¼ºå°‘æç¤ºè¯`);
                    return;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨åå°æ¨¡å¼
            const backgroundMode = document.getElementById('backgroundMode').checked;
            
            if (backgroundMode) {
                // åå°æ¨¡å¼ï¼šä¸€æ¬¡æ€§æäº¤æ‰€æœ‰ä»»åŠ¡
                if (!confirm(`ç¡®å®šè¦ç”Ÿæˆ ${batchData.length} ä¸ªä»»åŠ¡å—ï¼Ÿ\n\nâœ… åå°æ¨¡å¼ï¼š\nâ€¢ ä»»åŠ¡å°†åœ¨æœåŠ¡ç«¯å¤„ç†\nâ€¢ å¯ä»¥è‡ªç”±åˆ‡æ¢é¡µé¢æˆ–å…³é—­æµè§ˆå™¨\nâ€¢ å®Œæˆååˆ°"ç”Ÿæˆè®°å½•"æŸ¥çœ‹ç»“æœ\nâ€¢ ä¼°è®¡è€—æ—¶: ${batchData.length * 15}~${batchData.length * 30} ç§’`)) {
                    return;
                }
                await startBackgroundBatchGeneration();
            } else {
                // å‰å°æ¨¡å¼ï¼šé€ä¸ªç”Ÿæˆï¼ˆæ—§æ–¹å¼ï¼‰
                if (!confirm(`ç¡®å®šè¦ç”Ÿæˆ ${batchData.length} ä¸ªä»»åŠ¡å—ï¼Ÿ\n\nâš ï¸ å‰å°æ¨¡å¼ï¼š\nâ€¢ éœ€è¦ä¿æŒé¡µé¢æ‰“å¼€\nâ€¢ å¯ä»¥çœ‹åˆ°å®æ—¶è¿›åº¦\nâ€¢ åˆ‡æ¢é¡µé¢å¯èƒ½å½±å“ç”Ÿæˆ`)) {
                    return;
                }
                await startForegroundBatchGeneration();
            }
        }
        
        // åå°æ‰¹é‡ç”Ÿæˆï¼ˆæœåŠ¡ç«¯å¤„ç†ï¼‰
        async function startBackgroundBatchGeneration() {
            
            const progressArea = document.getElementById('progressArea');
            const progressFill = document.getElementById('progressFill');
            const progressLog = document.getElementById('progressLog');
            
            progressArea.classList.add('active');
            progressLog.innerHTML = '';
            
            // æ¸…ç©ºæ—§æ—¥å¿—ï¼Œå¼€å§‹æ–°çš„ç”Ÿæˆä»»åŠ¡
            generationLogs = [];
            localStorage.removeItem('batchLogs');
            
            addLog('========================================', 'info');
            addLog(`ğŸš€ æäº¤æ‰¹é‡ä»»åŠ¡åˆ°æœåŠ¡ç«¯`, 'info');
            addLog(`ğŸ“¦ æ€»ä»»åŠ¡æ•°: ${batchData.length}`, 'info');
            addLog('========================================', 'info');
            
            try {
                const response = await fetch('/api/batch-generate-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tasks: batchData })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentBatchId = result.batch_id;
                    isGenerating = true;
                    generationStartTime = Date.now();
                    
                    // ç«‹å³ä¿å­˜æ‰¹æ¬¡IDå’ŒçŠ¶æ€ï¼ˆåŒ…å«ç”¨æˆ·åï¼‰
                    const currentUsername = getCurrentUsername();
                    localStorage.setItem('currentBatchId', currentBatchId);
                    localStorage.setItem('batchUsername', currentUsername);
                    localStorage.setItem('batchProgress', JSON.stringify({
                        completed: 0,
                        total: result.total_tasks,
                        startTime: generationStartTime
                    }));
                    
                    addLog(`âœ… ä»»åŠ¡å·²æˆåŠŸæäº¤åˆ°æœåŠ¡ç«¯`, 'success');
                    addLog(`ğŸ“‹ æ‰¹æ¬¡ID: ${result.batch_id}`, 'info');
                    addLog(`ğŸ”„ ä»»åŠ¡æ­£åœ¨åå°æ‰§è¡Œä¸­...`, 'info');
                    addLog('', 'info');
                    addLog('ğŸ’¡ æç¤º:', 'info');
                    addLog('â€¢ æ‚¨ç°åœ¨å¯ä»¥å…³é—­æ­¤é¡µé¢æˆ–åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢', 'info');
                    addLog('â€¢ ä»»åŠ¡ä¼šåœ¨æœåŠ¡ç«¯ç»§ç»­æ‰§è¡Œ', 'info');
                    addLog('â€¢ é¡µé¢ä¼šè‡ªåŠ¨æ›´æ–°è¿›åº¦', 'info');
                    addLog(`â€¢ é¢„è®¡å®Œæˆæ—¶é—´: ${Math.ceil(result.total_tasks * 20 / 60)} åˆ†é’Ÿ`, 'info');
                    
                    // å¼€å§‹è½®è¯¢è¿›åº¦
                    startProgressPolling(currentBatchId, result.total_tasks);
                } else {
                    addLog(`âŒ æäº¤å¤±è´¥: ${result.error}`, 'error');
                    alert('æäº¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                addLog(`âŒ æäº¤å‡ºé”™: ${error.message}`, 'error');
                alert('æäº¤å¤±è´¥: ' + error.message);
            }
        }
        
        // å‰å°æ‰¹é‡ç”Ÿæˆï¼ˆå®¢æˆ·ç«¯é€ä¸ªç”Ÿæˆï¼‰
        async function startForegroundBatchGeneration() {
            const progressArea = document.getElementById('progressArea');
            const progressFill = document.getElementById('progressFill');
            const progressLog = document.getElementById('progressLog');
            
            progressArea.classList.add('active');
            progressLog.innerHTML = '';
            isGenerating = true;
            generationStartTime = Date.now();
            
            // æ¸…ç©ºæ—§æ—¥å¿—ï¼Œå¼€å§‹æ–°çš„ç”Ÿæˆä»»åŠ¡
            generationLogs = [];
            localStorage.removeItem('batchLogs');
            
            let completed = 0;
            const total = batchData.length;
            
            addLog('========================================', 'info');
            addLog(`å¼€å§‹æ‰¹é‡ç”Ÿæˆ ${total} ä¸ªä»»åŠ¡`, 'info');
            addLog('æç¤ºï¼šæ‚¨å¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢ï¼Œç”Ÿæˆä¼šç»§ç»­è¿›è¡Œ', 'info');
            addLog('========================================', 'info');
            
            for (let i = 0; i < batchData.length; i++) {
                const task = batchData[i];
                const logPrefix = `[${i + 1}/${total}]`;
                
                // æ·»åŠ æ—¥å¿—
                addLog(`${logPrefix} å¼€å§‹ç”Ÿæˆ: ${task.prompt.substring(0, 30)}...`, 'info');
                
                try {
                    // ä½¿ç”¨ keepalive ç¡®ä¿è¯·æ±‚ä¸ä¼šè¢«ä¸­æ–­
                    const response = await fetch('/api/batch-generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(task),
                        keepalive: true  // å…³é”®ï¼šä¿æŒè¯·æ±‚æ´»è·ƒ
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        addLog(`${logPrefix} âœ“ æˆåŠŸç”Ÿæˆ ${result.images.length} å¼ å›¾ç‰‡`, 'success');
                    } else {
                        addLog(`${logPrefix} âœ— å¤±è´¥: ${result.error}`, 'error');
                    }
                } catch (error) {
                    addLog(`${logPrefix} âœ— é”™è¯¯: ${error.message}`, 'error');
                }
                
                completed++;
                const percent = Math.round((completed / total) * 100);
                progressFill.style.width = percent + '%';
                progressFill.textContent = percent + '%';
                
                // ä¿å­˜è¿›åº¦åˆ° localStorageï¼ˆåŒ…å«ç”¨æˆ·åï¼‰
                const currentUsername = getCurrentUsername();
                localStorage.setItem('batchUsername', currentUsername);
                localStorage.setItem('batchProgress', JSON.stringify({
                    completed: completed,
                    total: total,
                    startTime: generationStartTime
                }));
            }
            
            const elapsed = Math.round((Date.now() - generationStartTime) / 1000);
            addLog('========================================', 'info');
            addLog(`æ‰¹é‡ç”Ÿæˆå®Œæˆï¼å…± ${total} ä¸ªä»»åŠ¡ï¼Œè€—æ—¶ ${elapsed} ç§’`, 'success');
            addLog('è¯·å‰å¾€"ç”Ÿæˆè®°å½•"é¡µé¢æŸ¥çœ‹ç»“æœ', 'info');
            addLog('æç¤ºï¼šæ­¤æ—¥å¿—å°†ä¿ç•™åˆ°ä¸‹æ¬¡ç”Ÿæˆ', 'info');
            
            isGenerating = false;
            localStorage.removeItem('batchProgress');
            // æ³¨æ„ï¼šä¸åˆ é™¤ batchLogsï¼Œä¿ç•™æ—¥å¿—ç›´åˆ°ä¸‹æ¬¡ç”Ÿæˆ
            
            alert('æ‰¹é‡ç”Ÿæˆå®Œæˆï¼è¯·å‰å¾€"ç”Ÿæˆè®°å½•"é¡µé¢æŸ¥çœ‹ç»“æœã€‚');
        }
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isGenerating) {
                console.log('é¡µé¢å·²åˆ‡æ¢ï¼Œæ‰¹é‡ç”Ÿæˆä»»åŠ¡å°†ç»§ç»­åœ¨åå°æ‰§è¡Œ');
                addLog('ğŸ’¡ æ‚¨å·²åˆ‡æ¢é¡µé¢ï¼Œä»»åŠ¡å°†ç»§ç»­åœ¨åå°æ‰§è¡Œ', 'info');
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥é€»è¾‘
            } else if (!document.hidden) {
                // é¡µé¢è¿”å›æ—¶ï¼Œä¸ç®¡æ˜¯å¦æ­£åœ¨ç”Ÿæˆï¼Œéƒ½ç¡®ä¿è¿›åº¦åŒºåŸŸå¯è§
                const savedLogs = localStorage.getItem('batchLogs');
                if (savedLogs && JSON.parse(savedLogs).length > 0) {
                    document.getElementById('progressArea').classList.add('active');
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„æ‰¹æ¬¡ä»»åŠ¡
                const savedBatchId = localStorage.getItem('currentBatchId');
                if (savedBatchId && (!progressPollingInterval || !isGenerating)) {
                    // æ¢å¤è½®è¯¢
                    currentBatchId = savedBatchId;
                    isGenerating = true;
                    document.getElementById('progressArea').classList.add('active');
                    addLog('ğŸ”„ é¡µé¢å·²è¿”å›ï¼Œæ¢å¤è¿›åº¦è½®è¯¢...', 'info');
                    
                    // ç«‹å³æŸ¥è¯¢ä¸€æ¬¡è¿›åº¦å¹¶æ¢å¤è½®è¯¢
                    fetch(`/api/batch-progress/${currentBatchId}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                const progress = data.progress;
                                const total = progress.total;
                                
                                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                                const completed = progress.completed + progress.failed;
                                const percent = Math.round((completed / total) * 100);
                                document.getElementById('progressFill').style.width = percent + '%';
                                document.getElementById('progressFill').textContent = percent + '%';
                                
                                // å¦‚æœä»»åŠ¡è¿˜åœ¨è¿›è¡Œä¸­ï¼Œæ¢å¤è½®è¯¢
                                if (progress.status === 'running') {
                                    startProgressPolling(currentBatchId, total);
                                    addLog(`âœ… å·²æ¢å¤è½®è¯¢ï¼Œå½“å‰è¿›åº¦: ${completed}/${total} (${percent}%)`, 'info');
                                } else {
                                    isGenerating = false;
                                    addLog(`âœ… ä»»åŠ¡å·²å®Œæˆï¼ŒæˆåŠŸ: ${progress.completed}, å¤±è´¥: ${progress.failed}`, 'success');
                                }
                            } else {
                                // æ‰¹æ¬¡ä¸å­˜åœ¨ï¼Œæ¸…ç†
                                localStorage.removeItem('currentBatchId');
                                localStorage.removeItem('batchProgress');
                                localStorage.removeItem('batchUsername');
                                isGenerating = false;
                                addLog('âš ï¸ æ‰¹æ¬¡ä»»åŠ¡ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('æŸ¥è¯¢è¿›åº¦å¤±è´¥:', error);
                            addLog('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                        });
                } else if (isGenerating) {
                    console.log('é¡µé¢å·²è¿”å›ï¼Œæ‰¹é‡ç”Ÿæˆä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­');
                    // æ¢å¤æ˜¾ç¤ºè¿›åº¦
                    const progress = localStorage.getItem('batchProgress');
                    if (progress) {
                        const data = JSON.parse(progress);
                        const percent = Math.round((data.completed / data.total) * 100);
                        document.getElementById('progressFill').style.width = percent + '%';
                        document.getElementById('progressFill').textContent = percent + '%';
                        addLog(`âœ… é¡µé¢å·²è¿”å›ï¼Œå½“å‰è¿›åº¦: ${data.completed}/${data.total} (${percent}%)`, 'info');
                    }
                } else {
                    console.log('é¡µé¢å·²è¿”å›ï¼Œæ˜¾ç¤ºä¹‹å‰çš„ç”Ÿæˆæ—¥å¿—');
                }
            }
        });
        
        // å¼€å§‹è½®è¯¢è¿›åº¦
        function startProgressPolling(batchId, totalTasks) {
            // æ¸…é™¤å·²æœ‰çš„è½®è¯¢
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
            }
            
            // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
            progressPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/batch-progress/${batchId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const progress = data.progress;
                        const completed = progress.completed + progress.failed;
                        const percent = Math.round((completed / progress.total) * 100);
                        
                        // æ¯æ¬¡è½®è¯¢éƒ½ä¿å­˜çŠ¶æ€ï¼ˆå…³é”®ï¼šæŒç»­ä¿å­˜ï¼ŒåŒ…å«ç”¨æˆ·åï¼‰
                        const currentUsername = getCurrentUsername();
                        localStorage.setItem('currentBatchId', batchId);
                        localStorage.setItem('batchUsername', currentUsername);
                        localStorage.setItem('batchProgress', JSON.stringify({
                            completed: completed,
                            total: progress.total,
                            startTime: generationStartTime
                        }));
                        
                        // æ›´æ–°è¿›åº¦æ¡
                        const progressFill = document.getElementById('progressFill');
                        if (progressFill) {
                            progressFill.style.width = percent + '%';
                            progressFill.textContent = `${completed}/${progress.total} (${percent}%)`;
                            
                            if (progress.status === 'completed') {
                                progressFill.style.background = '#28a745';
                            } else {
                                progressFill.style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
                            }
                        }
                        
                        // æ¯æ¬¡è½®è¯¢éƒ½ä¿å­˜çŠ¶æ€ï¼ˆå…³é”®ï¼šæŒç»­ä¿å­˜ï¼‰
                        localStorage.setItem('currentBatchId', batchId);
                        localStorage.setItem('batchProgress', JSON.stringify({
                            completed: completed,
                            total: progress.total,
                            startTime: generationStartTime
                        }));
                        
                        // å¦‚æœå®Œæˆï¼Œåœæ­¢è½®è¯¢
                        if (progress.status === 'completed') {
                            clearInterval(progressPollingInterval);
                            progressPollingInterval = null;
                            isGenerating = false;
                            localStorage.removeItem('currentBatchId');
                            localStorage.removeItem('batchProgress');
                            localStorage.removeItem('batchUsername');
                            
                            const elapsed = Math.round((Date.now() - generationStartTime) / 1000);
                            addLog('========================================', 'info');
                            addLog(`ğŸ‰ æ‰¹é‡ç”Ÿæˆå®Œæˆï¼`, 'success');
                            addLog(`âœ… æˆåŠŸ: ${progress.completed} ä¸ª`, 'success');
                            if (progress.failed > 0) {
                                addLog(`âŒ å¤±è´¥: ${progress.failed} ä¸ª`, 'error');
                            }
                            addLog(`â±ï¸ æ€»è€—æ—¶: ${elapsed} ç§’`, 'info');
                            addLog('ğŸ“Š è¯·å‰å¾€"ç”Ÿæˆè®°å½•"é¡µé¢æŸ¥çœ‹ç»“æœ', 'info');
                            
                            alert(`ğŸ‰ æ‰¹é‡ç”Ÿæˆå®Œæˆï¼\n\næˆåŠŸ: ${progress.completed} ä¸ª\nå¤±è´¥: ${progress.failed} ä¸ª\nè€—æ—¶: ${elapsed} ç§’\n\nè¯·åˆ°"ç”Ÿæˆè®°å½•"é¡µé¢æŸ¥çœ‹ç»“æœã€‚`);
                        }
                    }
                } catch (error) {
                    console.error('è½®è¯¢è¿›åº¦å¤±è´¥:', error);
                }
            }, 2000);
        }
        
        // åœæ­¢è½®è¯¢
        function stopProgressPolling() {
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
        }

        // ä¿æŒåŸæœ‰è¡Œä¸ºï¼šä¸æä¾›é‡æ–°ç”Ÿæˆ/æ¸…é™¤ç¼“å­˜åŠŸèƒ½
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const log = document.getElementById('progressLog');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            
            // ä¿å­˜æ—¥å¿—åˆ° localStorage
            generationLogs.push({ message: message, type: type, time: Date.now() });
            // åªä¿ç•™æœ€è¿‘500æ¡æ—¥å¿—
            if (generationLogs.length > 500) {
                generationLogs = generationLogs.slice(-500);
            }
            localStorage.setItem('batchLogs', JSON.stringify(generationLogs));
        }
    </script>
</body>
</html>
