<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å›¾ç‰‡ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .form-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="number"] {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: #f8f9ff;
        }
        
        .upload-area:hover {
            background-color: #f0f2ff;
        }
        
        .upload-area input[type="file"] {
            display: none;
        }
        
        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .preview-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .preview-image {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-image .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .generate-btn:active {
            transform: translateY(0);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .result-image {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.3s;
        }
        
        .result-image:hover {
            transform: scale(1.05);
        }
        
        .result-image img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .result-info {
            padding: 15px;
            background: #f8f9fa;
        }
        
        .result-info p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #666;
        }
        
        .download-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            width: 100%;
        }
        
        .download-btn:hover {
            background: #5568d3;
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        .sample-images-section {
            margin-bottom: 20px;
        }
        
        .sample-images-title {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sample-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        
        .sample-image-item {
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            border: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .sample-image-item:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .sample-image-item.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px #667eea;
        }
        
        .sample-image-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
        }
        
        .sample-image-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
        }
        
        .sample-image-item.selected .sample-image-count {
            opacity: 1;
        }
        
        .sample-images-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .sample-images-hint {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        .nav-bar {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto 20px auto;
        }
        
        .nav-bar a {
            color: #667eea;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .nav-bar a:hover {
            background: #667eea;
            color: white;
        }
        
        .nav-bar a.active {
            background: #667eea;
            color: white;
        }
        
        .user-info {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #666;
            font-weight: 500;
        }
        
        .user-info .username {
            color: #667eea;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white !important;
            padding: 6px 14px !important;
            font-size: 0.9em;
        }
        
        .logout-btn:hover {
            background: #c82333 !important;
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <a href="/" class="active">ğŸ¨ å•å›¾ç”Ÿæˆ</a>
        <a href="/batch">ğŸ“¦ æ‰¹é‡ç”Ÿæˆ</a>
        <a href="/records">ğŸ“Š ç”Ÿæˆè®°å½•</a>
        <a href="/script-analysis">ğŸ¬ å‰§æœ¬åˆ†æ</a>
        <a href="/manage-samples">ğŸ–¼ï¸ ç´ æç®¡ç†</a>
        {% if user.username == 'system_admin' %}
        <a href="/stats">ğŸ“ˆ ç³»ç»Ÿç»Ÿè®¡</a>
        {% endif %}
        <div class="user-info">
            <span>ğŸ‘¤ <span class="username">{{ user.username }}</span></span>
            <a href="/logout" class="logout-btn">ç™»å‡º</a>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ AI å›¾ç‰‡ç”Ÿæˆå™¨</h1>
            <p>è¾“å…¥æç¤ºè¯ï¼Œä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼Œç”Ÿæˆç²¾ç¾çš„ AI å›¾ç‰‡</p>
        </div>
        
        <div class="content">
            <div class="form-section">
                <div class="error-message" id="errorMessage"></div>
                
                <form id="generateForm">
                    <div class="form-group">
                        <label for="prompt">æç¤ºè¯ *</label>
                        <textarea id="prompt" name="prompt" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å›¾ç‰‡..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="negative_prompt">è´Ÿé¢æç¤ºè¯</label>
                        <textarea id="negative_prompt" name="negative_prompt" placeholder="æè¿°ä¸æƒ³å‡ºç°çš„å†…å®¹..."></textarea>
                    </div>
                    
                    <div class="sample-images-section">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                            <div class="sample-images-title">ğŸ–¼ï¸ é€‰æ‹©ç¤ºä¾‹å›¾ç‰‡ï¼ˆä»OSSï¼‰</div>
                            <div style="margin-left: auto; display:flex; gap:8px;">
                                <button type="button" id="samplePersonBtn" class="btn btn-primary">äººç‰©åº“</button>
                                <button type="button" id="sampleSceneBtn" class="btn">åœºæ™¯åº“</button>
                            </div>
                        </div>
                        <div class="sample-images-grid" id="sampleImagesGrid">
                            <div class="sample-images-loading">åŠ è½½ä¸­...</div>
                        </div>
                        <p class="sample-images-hint">
                            ğŸ’¡ ç‚¹å‡»é€‰æ‹©1-4å¼ ç¤ºä¾‹å›¾ä½œä¸ºå‚è€ƒå›¾ï¼Œå¯ä¸æ‰‹åŠ¨ä¸Šä¼ çš„å›¾ç‰‡ä¸€èµ·ä½¿ç”¨
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label>æ‰‹åŠ¨ä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼ˆæœ€å¤š 4 å¼ ï¼‰</label>
                        <div class="upload-area" onclick="document.getElementById('imageUpload').click()">
                            <div class="upload-icon">ğŸ“</div>
                            <p>ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</p>
                            <p style="font-size: 0.9em; color: #666; margin-top: 5px;">æ”¯æŒ JPG, PNG æ ¼å¼</p>
                            <input type="file" id="imageUpload" name="images" multiple accept="image/*" onchange="handleFileSelect(event)">
                        </div>
                        <p style="font-size: 0.85em; color: #ff6b6b; margin-top: 8px;">
                            âš ï¸ æ³¨æ„ï¼šå‚è€ƒå›¾ç‰‡åŠŸèƒ½éœ€è¦é…ç½®å¯¹è±¡å­˜å‚¨ï¼ˆTOS/OSSï¼‰ã€‚å¦‚æœªé…ç½®ï¼Œå°†ä»…ä½¿ç”¨æ–‡å­—ç”Ÿæˆå›¾ç‰‡ã€‚
                            <a href="/static/IMAGE_UPLOAD_CONFIG.md" target="_blank" style="color: #667eea; text-decoration: underline;">æŸ¥çœ‹é…ç½®è¯´æ˜</a>
                        </p>
                        <div class="preview-images" id="previewImages"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aspect_ratio">å›¾ç‰‡æ¯”ä¾‹</label>
                            <select id="aspect_ratio" name="aspect_ratio">
                                <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                                <option value="2:3">2:3 (ç«–å±)</option>
                                <option value="3:2">3:2 (æ¨ªå±)</option>
                                <option value="3:4">3:4 (ç«–å±)</option>
                                <option value="4:3">4:3 (æ¨ªå±)</option>
                                <option value="16:9">16:9 (å®½å±)</option>
                                <option value="9:16">9:16 (æ‰‹æœºå±)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="resolution">åˆ†è¾¨ç‡</label>
                            <select id="resolution" name="resolution">
                                <option value="1k">1K</option>
                                <option value="2k" selected>2K</option>
                                <option value="4k">4K</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="num_images">ç”Ÿæˆæ•°é‡</label>
                            <input type="number" id="num_images" name="num_images" value="1" min="1" max="10">
                        </div>
                        
                        <div class="form-group">
                            <label for="steps">é‡‡æ ·æ­¥æ•°</label>
                            <input type="number" id="steps" name="steps" value="28" min="1" max="100">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="seed">ç§å­å€¼ï¼ˆ0 ä¸ºéšæœºï¼‰</label>
                            <input type="number" id="seed" name="seed" value="0" min="0" max="99999999">
                        </div>
                        
                        <div class="form-group">
                            <label for="output_filename">è¾“å‡ºæ–‡ä»¶å</label>
                            <input type="text" id="output_filename" name="output_filename" value="generated" placeholder="æ–‡ä»¶å">
                        </div>
                    </div>
                    
                    <button type="submit" class="generate-btn" id="generateBtn">
                        ğŸš€ å¼€å§‹ç”Ÿæˆ
                    </button>
                    <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                        <button type="button" id="clearCacheBtn" class="btn btn-secondary" onclick="clearIndexCache()">æ¸…é™¤æœ¬åœ°ç¼“å­˜</button>
                        <label style="display:flex; align-items:center; gap:6px; margin-left:8px; font-size:0.9em; color:#666;">
                            <input type="checkbox" id="autoClearOnReload">
                            åˆ·æ–°æ—¶è‡ªåŠ¨æ¸…é™¤ç¼“å­˜
                        </label>
                    </div>
                </form>
            </div>
            
            <div class="result-section">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...</p>
                </div>
                
                <div class="result-images" id="resultImages"></div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedFiles = [];
        let selectedSampleImages = [];
        let sampleImages = [];
        
        // ä¿å­˜è¡¨å•æ•°æ®åˆ°localStorage
        function saveFormData() {
            try {
                const formData = {
                    prompt: document.getElementById('prompt').value,
                    negative_prompt: document.getElementById('negative_prompt').value,
                    aspect_ratio: document.getElementById('aspect_ratio').value,
                    resolution: document.getElementById('resolution').value,
                    num_images: document.getElementById('num_images').value,
                    steps: document.getElementById('steps').value,
                    seed: document.getElementById('seed').value,
                    output_filename: document.getElementById('output_filename').value
                };
                localStorage.setItem('indexFormData', JSON.stringify(formData));
            } catch (e) {
                console.error('ä¿å­˜è¡¨å•æ•°æ®å¤±è´¥:', e);
            }
        }
        
        // æ¢å¤è¡¨å•æ•°æ®
        function loadFormData() {
            try {
                const saved = localStorage.getItem('indexFormData');
                if (saved) {
                    const formData = JSON.parse(saved);
                    document.getElementById('prompt').value = formData.prompt || '';
                    document.getElementById('negative_prompt').value = formData.negative_prompt || '';
                    document.getElementById('aspect_ratio').value = formData.aspect_ratio || '1:1';
                    document.getElementById('resolution').value = formData.resolution || '2k';
                    document.getElementById('num_images').value = formData.num_images || 1;
                    document.getElementById('steps').value = formData.steps || 28;
                    document.getElementById('seed').value = formData.seed || 0;
                    document.getElementById('output_filename').value = formData.output_filename || 'generated';
                }
            } catch (e) {
                console.error('æ¢å¤è¡¨å•æ•°æ®å¤±è´¥:', e);
            }
        }
        
        // ç›‘å¬è¡¨å•è¾“å…¥å˜åŒ–
        function setupAutoSave() {
            const inputs = ['prompt', 'negative_prompt', 'aspect_ratio', 'resolution', 'num_images', 'steps', 'seed', 'output_filename'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveFormData);
                    element.addEventListener('input', saveFormData);
                }
            });
        }
        
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            if (selectedFiles.length + files.length > 4) {
                alert('æœ€å¤šåªèƒ½ä¸Šä¼  4 å¼ å›¾ç‰‡');
                return;
            }
            
            selectedFiles = selectedFiles.concat(files.slice(0, 4 - selectedFiles.length));
            updatePreview();
        }
        
        function updatePreview() {
            const previewContainer = document.getElementById('previewImages');
            previewContainer.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'preview-image';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="é¢„è§ˆ">
                        <button class="remove-btn" onclick="removeFile(${index})">Ã—</button>
                    `;
                    previewContainer.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updatePreview();
        }
        
        // ä¿æŒè¿æ¥æ´»è·ƒï¼Œé˜²æ­¢é¡µé¢åˆ‡æ¢æ—¶ä¸­æ–­è¯·æ±‚
        let keepAliveController = null;
        let currentGenerationState = null;
        
        // é¡µé¢åŠ è½½æ—¶æ¢å¤ç”ŸæˆçŠ¶æ€
        window.addEventListener('load', function() {
            const savedState = localStorage.getItem('singleGenerationState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    const elapsed = Date.now() - state.startTime;
                    
                    // å¦‚æœæ˜¯è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼ˆ30åˆ†é’Ÿå†…ï¼‰
                    if (state.status === 'generating' && elapsed < 30 * 60 * 1000) {
                        const loading = document.getElementById('loading');
                        loading.classList.add('active');
                        document.getElementById('generateBtn').disabled = true;
                        document.getElementById('generateBtn').textContent = 'ç”Ÿæˆä¸­...';
                    }
                    // å¦‚æœæ˜¯å·²å®Œæˆçš„ä»»åŠ¡ï¼Œæ¢å¤æ˜¾ç¤ºç»“æœ
                    else if (state.status === 'completed' && state.result) {
                        displayResults(state.result);
                    }
                } catch (e) {
                    console.error('æ¢å¤ç”ŸæˆçŠ¶æ€å¤±è´¥:', e);
                }
            }
        });
        
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const errorMessage = document.getElementById('errorMessage');
            const loading = document.getElementById('loading');
            const resultImages = document.getElementById('resultImages');
            const generateBtn = document.getElementById('generateBtn');
            
            // å¼€å§‹æ–°çš„ç”Ÿæˆï¼Œæ¸…ç©ºä¹‹å‰çš„ç»“æœå’ŒçŠ¶æ€
            errorMessage.classList.remove('active');
            loading.classList.add('active');
            resultImages.innerHTML = '';
            generateBtn.disabled = true;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            
            // ä¿å­˜ç”ŸæˆçŠ¶æ€ä¸ºè¿›è¡Œä¸­
            currentGenerationState = {
                status: 'generating',
                startTime: Date.now()
            };
            localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
            
            const formData = new FormData(this);
            
            // æ·»åŠ æ‰‹åŠ¨ä¸Šä¼ çš„æ–‡ä»¶
            selectedFiles.forEach(file => {
                formData.append('images', file);
            });
            
            // æ·»åŠ é€‰ä¸­çš„ç¤ºä¾‹å›¾ URL
            selectedSampleImages.forEach(img => {
                formData.append('sample_image_urls', img.url);
            });
            
            try {
                // ä½¿ç”¨ keepalive é€‰é¡¹ï¼Œç¡®ä¿å³ä½¿é¡µé¢å…³é—­è¯·æ±‚ä¹Ÿä¼šå®Œæˆ
                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData,
                    keepalive: true  // å…³é”®ï¼šä¿æŒè¯·æ±‚æ´»è·ƒ
                });
                
                const data = await response.json();
                
                if (data.error) {
                    errorMessage.textContent = data.error;
                    errorMessage.classList.add('active');
                    // æ›´æ–°çŠ¶æ€ä¸ºå¤±è´¥
                    currentGenerationState = {
                        status: 'failed',
                        error: data.error,
                        startTime: currentGenerationState.startTime
                    };
                    localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                } else if (data.success) {
                    displayResults(data);
                    // ä¿å­˜å®ŒæˆçŠ¶æ€å’Œç»“æœ
                    currentGenerationState = {
                        status: 'completed',
                        result: data,
                        startTime: currentGenerationState.startTime
                    };
                    localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                    
                    // æç¤ºç”¨æˆ·å¯ä»¥åœ¨ç”Ÿæˆè®°å½•ä¸­æŸ¥çœ‹
                    if (data.images && data.images.length > 0) {
                        console.log('å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼Œå¯åœ¨ç”Ÿæˆè®°å½•é¡µé¢æŸ¥çœ‹');
                    }
                }
            } catch (error) {
                errorMessage.textContent = 'ç”Ÿæˆå¤±è´¥: ' + error.message;
                errorMessage.classList.add('active');
                // æ›´æ–°çŠ¶æ€ä¸ºå¤±è´¥
                currentGenerationState = {
                    status: 'failed',
                    error: error.message,
                    startTime: currentGenerationState ? currentGenerationState.startTime : Date.now()
                };
                localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
            } finally {
                loading.classList.remove('active');
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
            }
        });
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œæç¤ºç”¨æˆ·
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                const loading = document.getElementById('loading');
                if (loading.classList.contains('active')) {
                    console.log('é¡µé¢å·²åˆ‡æ¢ï¼Œä½†ç”Ÿæˆä»»åŠ¡å°†ç»§ç»­åœ¨åå°æ‰§è¡Œ');
                }
            } else {
                // é¡µé¢è¿”å›æ—¶ï¼Œæ£€æŸ¥å¹¶æ¢å¤çŠ¶æ€
                const savedState = localStorage.getItem('singleGenerationState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        if (state.status === 'completed' && state.result) {
                            // å¦‚æœç»“æœåŒºåŸŸæ˜¯ç©ºçš„ï¼Œé‡æ–°æ˜¾ç¤ºç»“æœ
                            const resultImages = document.getElementById('resultImages');
                            if (!resultImages.hasChildNodes()) {
                                displayResults(state.result);
                            }
                        }
                    } catch (e) {
                        console.error('æ¢å¤çŠ¶æ€å¤±è´¥:', e);
                    }
                }
            }
        });
        
        function displayResults(data) {
            const resultImages = document.getElementById('resultImages');
            
            data.images.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'result-image';
                div.innerHTML = `
                    <img src="${img.url}" alt="ç”Ÿæˆçš„å›¾ç‰‡ ${index + 1}">
                    <div class="result-info">
                        <p><strong>æ–‡ä»¶å:</strong> ${img.filename}</p>
                        <p><strong>ç§å­å€¼:</strong> ${img.seed}</p>
                        <p><strong>å°ºå¯¸:</strong> ${data.params.width} Ã— ${data.params.height}</p>
                        <a href="${img.url}" download="${img.filename}">
                            <button class="download-btn">â¬‡ï¸ ä¸‹è½½å›¾ç‰‡</button>
                        </a>
                        <button class="download-btn" onclick="addToPersonLibrary('${img.url}', '${img.filename}')">â• æ·»åŠ åˆ°äººç‰©åº“</button>
                        <button class="download-btn" onclick="addToSceneLibrary('${img.url}', '${img.filename}')">â• æ·»åŠ åˆ°åœºæ™¯åº“</button>
                        <button class="download-btn" onclick="regenerateLast()">ğŸ” é‡æ–°ç”Ÿæˆ</button>
                    </div>
                `;
                resultImages.appendChild(div);
            });
            // ä¿å­˜æœ€åä¸€æ¬¡ç”Ÿæˆçš„å‚æ•°ï¼Œä¾¿äºé‡æ–°ç”Ÿæˆ
            try {
                const payload = buildLastGeneratePayload();
                localStorage.setItem('lastGenerationPayload', JSON.stringify(payload));
            } catch (e) { console.error('ä¿å­˜æœ€åç”Ÿæˆå‚æ•°å¤±è´¥', e); }
        }
        
        // æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.querySelector('.upload-area');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#e8eaff';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.backgroundColor = '#f8f9ff';
        });
        
        uploadArea.addEventListener('drop', (e) => {
                        // åœ¨æäº¤å‰ä¿å­˜æœ¬æ¬¡ç”Ÿæˆå‚æ•°ï¼ˆä¸åŒ…å«æœ¬åœ°æ–‡ä»¶ï¼‰
                        const payloadToSave = buildLastGeneratePayload();
                        localStorage.setItem('lastGenerationPayload', JSON.stringify(payloadToSave));
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f8f9ff';
            
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            
            if (selectedFiles.length + files.length > 4) {
                alert('æœ€å¤šåªèƒ½ä¸Šä¼  4 å¼ å›¾ç‰‡');
                return;
            }
            
            selectedFiles = selectedFiles.concat(files.slice(0, 4 - selectedFiles.length));
            updatePreview();
        });
        
        // ç¤ºä¾‹å›¾ç±»åˆ«ï¼ˆperson/sceneï¼‰
        let sampleCategory = 'person';

        

        function switchSampleCategory(cat) {
            sampleCategory = cat;
            document.getElementById('samplePersonBtn').classList.toggle('btn-primary', cat === 'person');
            document.getElementById('sampleSceneBtn').classList.toggle('btn-primary', cat === 'scene');
            loadSampleImages(cat);
        }

        // åŠ è½½ç¤ºä¾‹å›¾ç‰‡ï¼ˆæŒ‰ç±»åˆ«ï¼‰
        async function loadSampleImages(category) {
            const grid = document.getElementById('sampleImagesGrid');
            grid.innerHTML = '<div class="sample-images-loading">åŠ è½½ä¸­...</div>';
            try {
                const response = await fetch('/api/sample-images?category=' + encodeURIComponent(category));
                const data = await response.json();

                if (data.success && data.images.length > 0) {
                    sampleImages = data.images;
                    grid.innerHTML = '';
                    data.images.forEach((img, index) => {
                        const div = document.createElement('div');
                        div.className = 'sample-image-item';
                        div.onclick = () => toggleSampleImage(index);
                        div.innerHTML = `
                            <img src="${img.url}" alt="${img.filename}" title="${img.filename}">
                            <div class="sample-image-count"></div>
                        `;
                        grid.appendChild(div);
                    });
                } else {
                    grid.innerHTML = '<div class="sample-images-loading">ğŸ’­ æš‚æ— ç¤ºä¾‹å›¾ç‰‡</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ç¤ºä¾‹å›¾å¤±è´¥:', error);
                grid.innerHTML = '<div class="sample-images-loading">âŒ åŠ è½½å¤±è´¥</div>';
            }
        }

        // å°†ç”Ÿæˆå›¾ç‰‡æ·»åŠ åˆ°äººç‰©/ç´ æåº“
        async function addToPersonLibrary(url, filename) {
            try {
                const resp = await fetch('/api/add-to-person-library', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, filename: filename })
                });
                const data = await resp.json();
                    if (data.success) {
                    alert('å·²æ·»åŠ åˆ°äººç‰©åº“');
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        }

        // å°†ç”Ÿæˆå›¾ç‰‡æ·»åŠ åˆ°åœºæ™¯åº“
        async function addToSceneLibrary(url, filename) {
            try {
                const resp = await fetch('/api/add-to-scene-library', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, filename: filename })
                });
                const data = await resp.json();
                if (data.success) {
                    alert('å·²æ·»åŠ åˆ°åœºæ™¯åº“');
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        }
        
        // åˆ‡æ¢ç¤ºä¾‹å›¾é€‰æ‹©çŠ¶æ€
        function toggleSampleImage(index) {
            const img = sampleImages[index];
            const existingIndex = selectedSampleImages.findIndex(s => s.url === img.url);
            
            if (existingIndex >= 0) {
                // å–æ¶ˆé€‰ä¸­
                selectedSampleImages.splice(existingIndex, 1);
            } else {
                // æ£€æŸ¥æ€»æ•°é™åˆ¶ï¼ˆæ‰‹åŠ¨ä¸Šä¼  + ç¤ºä¾‹å›¾ <= 4ï¼‰
                const totalSelected = selectedFiles.length + selectedSampleImages.length;
                if (totalSelected >= 4) {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹© 4 å¼ å›¾ç‰‡ï¼ˆåŒ…æ‹¬æ‰‹åŠ¨ä¸Šä¼ å’Œç¤ºä¾‹å›¾ï¼‰');
                    return;
                }
                selectedSampleImages.push(img);
            }
            
            updateSampleImagesUI();
        }
        
        // æ›´æ–°ç¤ºä¾‹å›¾ UI
        function updateSampleImagesUI() {
            const grid = document.getElementById('sampleImagesGrid');
            const items = grid.querySelectorAll('.sample-image-item');
            
            items.forEach((item, index) => {
                const img = sampleImages[index];
                const selectedIndex = selectedSampleImages.findIndex(s => s.url === img.url);
                
                if (selectedIndex >= 0) {
                    item.classList.add('selected');
                    const countDiv = item.querySelector('.sample-image-count');
                    countDiv.textContent = selectedIndex + 1;
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–ç¤ºä¾‹å›¾å’Œæ¢å¤è¡¨å•æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç±»åˆ«æŒ‰é’®
            const btnP = document.getElementById('samplePersonBtn');
            const btnS = document.getElementById('sampleSceneBtn');
            if (btnP && btnS) {
                btnP.addEventListener('click', () => switchSampleCategory('person'));
                btnS.addEventListener('click', () => switchSampleCategory('scene'));
            }
            // é»˜è®¤åŠ è½½
            loadSampleImages(sampleCategory);
            loadFormData();
            setupAutoSave();
        });
    </script>
</body>
</html>
