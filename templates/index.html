<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å›¾ç‰‡ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .form-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="number"] {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: #f8f9ff;
        }
        
        .upload-area:hover {
            background-color: #f0f2ff;
        }
        
        .upload-area input[type="file"] {
            display: none;
        }
        
        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .preview-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .preview-image {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-image .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .generate-btn:active {
            transform: translateY(0);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .result-image {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.3s;
        }
        
        .result-image:hover {
            transform: scale(1.05);
        }
        
        .result-image img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .result-info {
            padding: 15px;
            background: #f8f9fa;
        }
        
        .result-info p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #666;
        }
        
        .download-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            width: 100%;
        }
        
        .download-btn:hover {
            background: #5568d3;
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        .sample-images-section {
            margin-bottom: 20px;
        }
        
        .sample-images-title {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sample-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        
        .sample-image-item {
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            border: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .sample-image-item:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .sample-image-item.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px #667eea;
        }
        
        .sample-image-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
        }
        
        .sample-image-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
        }
        
        .sample-image-item.selected .sample-image-count {
            opacity: 1;
        }
        
        .sample-images-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .sample-images-hint {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        .nav-bar {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto 20px auto;
        }
        
        .nav-bar a {
            color: #667eea;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .nav-bar a:hover {
            background: #667eea;
            color: white;
        }
        
        .nav-bar a.active {
            background: #667eea;
            color: white;
        }
        
        .user-info {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #666;
            font-weight: 500;
        }
        
        .user-info .username {
            color: #667eea;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white !important;
            padding: 6px 14px !important;
            font-size: 0.9em;
        }
        
        .logout-btn:hover {
            background: #c82333 !important;
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <a href="/" class="active">ğŸ¨ å•å›¾ç”Ÿæˆ</a>
        <a href="/batch">ğŸ“¦ æ‰¹é‡ç”Ÿæˆ</a>
        <a href="/records">ğŸ“Š ç”Ÿæˆè®°å½•</a>
        <a href="/script-analysis">ğŸ¬ å‰§æœ¬åˆ†æ</a>
        <a href="/manage-samples">ğŸ–¼ï¸ ç´ æç®¡ç†</a>
        {% if user.username == 'system_admin' %}
        <a href="/stats">ğŸ“ˆ ç³»ç»Ÿç»Ÿè®¡</a>
        {% endif %}
        <div class="user-info">
            <span>ğŸ‘¤ <span class="username">{{ user.username }}</span></span>
            <a href="/logout" class="logout-btn">ç™»å‡º</a>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ AI å›¾ç‰‡ç”Ÿæˆå™¨</h1>
            <p>è¾“å…¥æç¤ºè¯ï¼Œä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼Œç”Ÿæˆç²¾ç¾çš„ AI å›¾ç‰‡</p>
        </div>
        
        <div class="content">
            <div class="form-section">
                <div class="error-message" id="errorMessage"></div>
                
                <form id="generateForm">
                    <div class="form-group">
                        <label for="prompt">æç¤ºè¯ *</label>
                        <textarea id="prompt" name="prompt" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å›¾ç‰‡..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="negative_prompt">è´Ÿé¢æç¤ºè¯</label>
                        <textarea id="negative_prompt" name="negative_prompt" placeholder="æè¿°ä¸æƒ³å‡ºç°çš„å†…å®¹..."></textarea>
                    </div>
                    
                    <div class="sample-images-section">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                            <div class="sample-images-title">ğŸ–¼ï¸ é€‰æ‹©ç¤ºä¾‹å›¾ç‰‡ï¼ˆä»OSSï¼‰</div>
                            <div style="margin-left: auto; display:flex; gap:8px;">
                                <button type="button" id="samplePersonBtn" class="btn btn-primary">äººç‰©åº“</button>
                                <button type="button" id="sampleSceneBtn" class="btn">åœºæ™¯åº“</button>
                            </div>
                        </div>
                        <div class="sample-images-grid" id="sampleImagesGrid">
                            <div class="sample-images-loading">åŠ è½½ä¸­...</div>
                        </div>
                        <p class="sample-images-hint">
                            ğŸ’¡ ç‚¹å‡»é€‰æ‹©1-4å¼ ç¤ºä¾‹å›¾ä½œä¸ºå‚è€ƒå›¾ï¼Œå¯ä¸æ‰‹åŠ¨ä¸Šä¼ çš„å›¾ç‰‡ä¸€èµ·ä½¿ç”¨
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label>æ‰‹åŠ¨ä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼ˆæœ€å¤š 4 å¼ ï¼‰</label>
                        <div class="upload-area" onclick="document.getElementById('imageUpload').click()">
                            <div class="upload-icon">ğŸ“</div>
                            <p>ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</p>
                            <p style="font-size: 0.9em; color: #666; margin-top: 5px;">æ”¯æŒ JPG, PNG æ ¼å¼</p>
                            <input type="file" id="imageUpload" name="images" multiple accept="image/*" onchange="handleFileSelect(event)">
                        </div>
                        <p style="font-size: 0.85em; color: #ff6b6b; margin-top: 8px;">
                            âš ï¸ æ³¨æ„ï¼šå‚è€ƒå›¾ç‰‡åŠŸèƒ½éœ€è¦é…ç½®å¯¹è±¡å­˜å‚¨ï¼ˆTOS/OSSï¼‰ã€‚å¦‚æœªé…ç½®ï¼Œå°†ä»…ä½¿ç”¨æ–‡å­—ç”Ÿæˆå›¾ç‰‡ã€‚
                            <a href="/static/IMAGE_UPLOAD_CONFIG.md" target="_blank" style="color: #667eea; text-decoration: underline;">æŸ¥çœ‹é…ç½®è¯´æ˜</a>
                        </p>
                        <div class="preview-images" id="previewImages"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aspect_ratio">å›¾ç‰‡æ¯”ä¾‹</label>
                            <select id="aspect_ratio" name="aspect_ratio">
                                <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                                <option value="2:3">2:3 (ç«–å±)</option>
                                <option value="3:2">3:2 (æ¨ªå±)</option>
                                <option value="3:4">3:4 (ç«–å±)</option>
                                <option value="4:3">4:3 (æ¨ªå±)</option>
                                <option value="16:9">16:9 (å®½å±)</option>
                                <option value="9:16">9:16 (æ‰‹æœºå±)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="resolution">åˆ†è¾¨ç‡</label>
                            <select id="resolution" name="resolution">
                                <option value="1k">1K</option>
                                <option value="2k" selected>2K</option>
                                <option value="4k">4K</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="num_images">ç”Ÿæˆæ•°é‡</label>
                            <input type="number" id="num_images" name="num_images" value="1" min="1" max="10">
                        </div>
                        
                        <div class="form-group">
                            <label for="steps">é‡‡æ ·æ­¥æ•°</label>
                            <input type="number" id="steps" name="steps" value="28" min="1" max="100">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="seed">ç§å­å€¼ï¼ˆ0 ä¸ºéšæœºï¼‰</label>
                            <input type="number" id="seed" name="seed" value="0" min="0" max="99999999">
                        </div>
                        
                        <div class="form-group">
                            <label for="output_filename">è¾“å‡ºæ–‡ä»¶å</label>
                            <input type="text" id="output_filename" name="output_filename" value="generated" placeholder="æ–‡ä»¶å">
                        </div>
                    </div>
                    
                    <button type="submit" class="generate-btn" id="generateBtn">
                        ğŸš€ å¼€å§‹ç”Ÿæˆ
                    </button>
                    <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                        <button type="button" id="clearCacheBtn" class="btn btn-secondary" onclick="clearIndexCache()">æ¸…é™¤æœ¬åœ°ç¼“å­˜</button>
                        <label style="display:flex; align-items:center; gap:6px; margin-left:8px; font-size:0.9em; color:#666;">
                            <input type="checkbox" id="autoClearOnReload">
                            åˆ·æ–°æ—¶è‡ªåŠ¨æ¸…é™¤ç¼“å­˜
                        </label>
                    </div>
                </form>
            </div>
            
            <div class="result-section">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...</p>
                </div>
                
                <div class="result-images" id="resultImages"></div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedFiles = [];
        let selectedSampleImages = [];
        let sampleImages = [];
        
        // ä¿å­˜è¡¨å•æ•°æ®åˆ°localStorageï¼ˆæŒ‰ç”¨æˆ·éš”ç¦»ï¼‰
        function saveFormData() {
            try {
                const currentUsername = getCurrentUsername();
                if (!currentUsername) return; // å¦‚æœæ²¡æœ‰ç”¨æˆ·åï¼Œä¸ä¿å­˜
                
                const formData = {
                    prompt: document.getElementById('prompt').value,
                    negative_prompt: document.getElementById('negative_prompt').value,
                    aspect_ratio: document.getElementById('aspect_ratio').value,
                    resolution: document.getElementById('resolution').value,
                    num_images: document.getElementById('num_images').value,
                    steps: document.getElementById('steps').value,
                    seed: document.getElementById('seed').value,
                    output_filename: document.getElementById('output_filename').value,
                    username: currentUsername // ä¿å­˜ç”¨æˆ·åç”¨äºéªŒè¯
                };
                localStorage.setItem('indexFormData', JSON.stringify(formData));
            } catch (e) {
                console.error('ä¿å­˜è¡¨å•æ•°æ®å¤±è´¥:', e);
            }
        }
        
        // æ¢å¤è¡¨å•æ•°æ®ï¼ˆæ£€æŸ¥ç”¨æˆ·åŒ¹é…ï¼‰
        function loadFormData() {
            try {
                const currentUsername = getCurrentUsername();
                const saved = localStorage.getItem('indexFormData');
                if (saved) {
                    const formData = JSON.parse(saved);
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åŒ¹é…
                    if (formData.username && formData.username !== currentUsername) {
                        console.log('æ£€æµ‹åˆ°ä¸åŒç”¨æˆ·çš„è¡¨å•æ•°æ®ï¼Œæ¸…é™¤æ—§æ•°æ®');
                        localStorage.removeItem('indexFormData');
                        return; // ä¸æ¢å¤å…¶ä»–ç”¨æˆ·çš„æ•°æ®
                    }
                    
                    // æ¢å¤è¡¨å•æ•°æ®
                    document.getElementById('prompt').value = formData.prompt || '';
                    document.getElementById('negative_prompt').value = formData.negative_prompt || '';
                    document.getElementById('aspect_ratio').value = formData.aspect_ratio || '1:1';
                    document.getElementById('resolution').value = formData.resolution || '2k';
                    document.getElementById('num_images').value = formData.num_images || 1;
                    document.getElementById('steps').value = formData.steps || 28;
                    document.getElementById('seed').value = formData.seed || 0;
                    document.getElementById('output_filename').value = formData.output_filename || 'generated';
                }
            } catch (e) {
                console.error('æ¢å¤è¡¨å•æ•°æ®å¤±è´¥:', e);
            }
        }
        
        // ç›‘å¬è¡¨å•è¾“å…¥å˜åŒ–
        function setupAutoSave() {
            const inputs = ['prompt', 'negative_prompt', 'aspect_ratio', 'resolution', 'num_images', 'steps', 'seed', 'output_filename'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveFormData);
                    element.addEventListener('input', saveFormData);
                }
            });
        }
        
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            if (selectedFiles.length + files.length > 4) {
                alert('æœ€å¤šåªèƒ½ä¸Šä¼  4 å¼ å›¾ç‰‡');
                return;
            }
            
            selectedFiles = selectedFiles.concat(files.slice(0, 4 - selectedFiles.length));
            updatePreview();
        }
        
        function updatePreview() {
            const previewContainer = document.getElementById('previewImages');
            previewContainer.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'preview-image';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="é¢„è§ˆ">
                        <button class="remove-btn" onclick="removeFile(${index})">Ã—</button>
                    `;
                    previewContainer.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updatePreview();
        }
        
        // ä¿æŒè¿æ¥æ´»è·ƒï¼Œé˜²æ­¢é¡µé¢åˆ‡æ¢æ—¶ä¸­æ–­è¯·æ±‚
        let keepAliveController = null;
        let currentGenerationState = null;
        let currentTaskId = null;
        let statusPollingInterval = null;
        
        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        function startStatusPolling(taskId) {
            console.log('%cğŸš€ å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€', 'color: blue; font-size: 14px; font-weight: bold;');
            console.log('ä»»åŠ¡ID:', taskId);
            updateDebugInfo('ğŸ”„ å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€', taskId);
            
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval);
            }
            
            statusPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/single-generation-status/${taskId}`);
                    const data = await response.json();
                    
                    // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
                    const logTime = new Date().toLocaleTimeString();
                    if (data.success && data.task) {
                        const task = data.task;
                        console.log(`%c[è½®è¯¢ ${logTime}] ä»»åŠ¡ ${taskId}`, 'color: blue; font-weight: bold;');
                        console.log(`  çŠ¶æ€: ${task.status}`);
                        console.log(`  å¼€å§‹æ—¶é—´: ${task.start_time}`);
                        console.log(`  ç»“æŸæ—¶é—´: ${task.end_time || 'æœªå®Œæˆ'}`);
                        console.log(`  ç»“æœ:`, task.result || 'æ— ');
                    } else {
                        console.error(`%c[è½®è¯¢ ${logTime}] ä»»åŠ¡ ${taskId} æŸ¥è¯¢å¤±è´¥`, 'color: red; font-weight: bold;');
                        console.error(`  é”™è¯¯:`, data.error || 'æœªçŸ¥é”™è¯¯');
                        console.error(`  å®Œæ•´å“åº”:`, data);
                    }
                    
                    if (data.success && data.task) {
                        const task = data.task;
                        
                        // æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆåŒ…å«ç”¨æˆ·åï¼‰
                        const currentUsername = getCurrentUsername();
                        currentGenerationState = {
                            status: task.status,
                            startTime: new Date(task.start_time).getTime(),
                            taskId: taskId,
                            username: currentUsername  // ä¿å­˜ç”¨æˆ·åç”¨äºéªŒè¯
                        };
                        // æ¯æ¬¡è½®è¯¢éƒ½ä¿å­˜çŠ¶æ€
                        localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                        
                        if (task.status === 'completed') {
                            // ä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢
                            clearInterval(statusPollingInterval);
                            statusPollingInterval = null;
                            
                            console.log('%câœ… ä»»åŠ¡å®Œæˆï¼', 'color: green; font-size: 16px; font-weight: bold;');
                            console.log('ä»»åŠ¡ID:', taskId);
                            console.log('å®Œæˆæ—¶é—´:', task.end_time || new Date().toISOString());
                            console.log('ç»“æœ:', task.result);
                            
                            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
                            updateDebugInfo('âœ… ä»»åŠ¡å·²å®Œæˆ', taskId);
                            
                            // å¦‚æœç»“æœåŒºåŸŸæ˜¯ç©ºçš„ï¼Œæç¤ºç”¨æˆ·æŸ¥çœ‹ç”Ÿæˆè®°å½•
                            const resultImages = document.getElementById('resultImages');
                            if (!resultImages.hasChildNodes()) {
                                resultImages.innerHTML = `
                                    <div style="text-align: center; padding: 40px;">
                                        <h3>âœ… ç”Ÿæˆå®Œæˆï¼</h3>
                                        <p>ä»»åŠ¡å·²å®Œæˆï¼Œè¯·å‰å¾€ <a href="/records">ç”Ÿæˆè®°å½•</a> æŸ¥çœ‹ç»“æœ</p>
                                        <p>ä»»åŠ¡ID: ${taskId}</p>
                                    </div>
                                `;
                            }
                            
                            const loading = document.getElementById('loading');
                            if (loading) {
                                loading.classList.remove('active');
                            }
                            const generateBtn = document.getElementById('generateBtn');
                            if (generateBtn) {
                                generateBtn.disabled = false;
                                generateBtn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
                            }
                        } else if (task.status === 'failed') {
                            // ä»»åŠ¡å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
                            clearInterval(statusPollingInterval);
                            statusPollingInterval = null;
                            
                            const errorMessage = document.getElementById('errorMessage');
                            errorMessage.textContent = task.error || 'ç”Ÿæˆå¤±è´¥';
                            errorMessage.classList.add('active');
                            
                            const loading = document.getElementById('loading');
                            loading.classList.remove('active');
                            document.getElementById('generateBtn').disabled = false;
                            document.getElementById('generateBtn').textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
                        } else if (task.status === 'generating') {
                            // ä»»åŠ¡è¿›è¡Œä¸­ï¼Œæ›´æ–°è¿›åº¦æ˜¾ç¤º
                            const progress = task.progress || 0;
                            const total = task.total || 1;
                            const loading = document.getElementById('loading');
                            if (!loading.classList.contains('active')) {
                                loading.classList.add('active');
                            }
                            document.getElementById('generateBtn').disabled = true;
                            document.getElementById('generateBtn').textContent = `ç”Ÿæˆä¸­... (${progress}/${total})`;
                            
                            // å¦‚æœä»»åŠ¡è¿›è¡Œä¸­è¶…è¿‡2åˆ†é’Ÿï¼Œä¸»åŠ¨æ£€æŸ¥æ•°æ®åº“è®°å½•
                            const startTime = new Date(task.start_time).getTime();
                            const elapsed = Date.now() - startTime;
                            if (elapsed > 2 * 60 * 1000) {  // 2åˆ†é’Ÿ
                                console.log('ä»»åŠ¡è¿›è¡Œä¸­è¶…è¿‡2åˆ†é’Ÿï¼Œä¸»åŠ¨æ£€æŸ¥æ•°æ®åº“è®°å½•...');
                                // æ£€æŸ¥æœ€è¿‘çš„ç”Ÿæˆè®°å½•
                                fetch('/api/records?limit=5')
                                    .then(res => res.json())
                                    .then(recordsData => {
                                        if (recordsData.success && recordsData.records && recordsData.records.length > 0) {
                                            const latestRecord = recordsData.records[0];
                                            const recordTime = new Date(latestRecord.created_at).getTime();
                                            const timeDiff = recordTime - startTime;
                                            
                                            // å¦‚æœè®°å½•åœ¨ä»»åŠ¡å¼€å§‹å2åˆ†é’Ÿå†…ï¼Œè®¤ä¸ºä»»åŠ¡å·²å®Œæˆ
                                            if (timeDiff >= 0 && timeDiff < 2 * 60 * 1000) {
                                                console.log('æ£€æµ‹åˆ°ä»»åŠ¡å·²å®Œæˆï¼Œæ›´æ–°çŠ¶æ€');
                                                // åœæ­¢è½®è¯¢
                                                clearInterval(statusPollingInterval);
                                                statusPollingInterval = null;
                                                
                                                // æ›´æ–°çŠ¶æ€
                                                const currentUsername = getCurrentUsername();
                                                currentGenerationState = {
                                                    status: 'completed',
                                                    startTime: startTime,
                                                    taskId: taskId,
                                                    username: currentUsername,
                                                    result: { images_count: 1 }
                                                };
                                                localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                                                
                                                // æ›´æ–°UI
                                                const resultImages = document.getElementById('resultImages');
                                                if (resultImages && !resultImages.hasChildNodes()) {
                                                    resultImages.innerHTML = `
                                                        <div style="text-align: center; padding: 40px;">
                                                            <h3>âœ… ç”Ÿæˆå®Œæˆï¼</h3>
                                                            <p>ä»»åŠ¡å·²å®Œæˆï¼Œè¯·å‰å¾€ <a href="/records">ç”Ÿæˆè®°å½•</a> æŸ¥çœ‹ç»“æœ</p>
                                                            <p>ä»»åŠ¡ID: ${taskId}</p>
                                                        </div>
                                                    `;
                                                }
                                                
                                                if (loading) {
                                                    loading.classList.remove('active');
                                                }
                                                const generateBtn = document.getElementById('generateBtn');
                                                if (generateBtn) {
                                                    generateBtn.disabled = false;
                                                    generateBtn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
                                                }
                                            }
                                        }
                                    })
                                    .catch(err => {
                                        console.error('æ£€æŸ¥ç”Ÿæˆè®°å½•å¤±è´¥:', err);
                                    });
                            }
                        }
                    } else {
                        // ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯å·²å®Œæˆä½†ä¸åœ¨å†…å­˜ä¸­
                        // æ£€æŸ¥ç”Ÿæˆè®°å½•ä¸­æ˜¯å¦æœ‰æœ€è¿‘ç”Ÿæˆçš„å›¾ç‰‡ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
                        const elapsed = Date.now() - (currentGenerationState?.startTime || Date.now());
                        if (elapsed < 5 * 60 * 1000) {  // 5åˆ†é’Ÿå†…
                            // å°è¯•æŸ¥è¯¢æœ€è¿‘çš„ç”Ÿæˆè®°å½•
                            fetch('/api/records?limit=1')
                                .then(res => res.json())
                                .then(recordsData => {
                                    if (recordsData.success && recordsData.records && recordsData.records.length > 0) {
                                        const latestRecord = recordsData.records[0];
                                        const recordTime = new Date(latestRecord.created_at).getTime();
                                        const timeDiff = Date.now() - recordTime;
                                        
                                        // å¦‚æœè®°å½•åœ¨5åˆ†é’Ÿå†…ï¼Œè®¤ä¸ºä»»åŠ¡å·²å®Œæˆ
                                        if (timeDiff < 5 * 60 * 1000) {
                                            console.log('æ£€æµ‹åˆ°æœ€è¿‘æœ‰ç”Ÿæˆè®°å½•ï¼Œä»»åŠ¡å¯èƒ½å·²å®Œæˆ');
                                            // æ›´æ–°çŠ¶æ€ä¸ºå®Œæˆï¼ˆåŒ…å«ç”¨æˆ·åï¼‰
                                            const currentUsername = getCurrentUsername();
                                            currentGenerationState = {
                                                status: 'completed',
                                                startTime: currentGenerationState?.startTime || recordTime,
                                                taskId: taskId,
                                                username: currentUsername
                                            };
                                            localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                                            
                                            // åœæ­¢è½®è¯¢
                                            clearInterval(statusPollingInterval);
                                            statusPollingInterval = null;
                                            
                                            // æ˜¾ç¤ºå®Œæˆæç¤º
                                            const resultImages = document.getElementById('resultImages');
                                            if (resultImages && !resultImages.hasChildNodes()) {
                                                resultImages.innerHTML = `
                                                    <div style="text-align: center; padding: 40px;">
                                                        <h3>âœ… ç”Ÿæˆå®Œæˆï¼</h3>
                                                        <p>ä»»åŠ¡å·²åœ¨åå°å®Œæˆï¼Œè¯·å‰å¾€ <a href="/records">ç”Ÿæˆè®°å½•</a> æŸ¥çœ‹ç»“æœ</p>
                                                        <p>ä»»åŠ¡ID: ${taskId}</p>
                                                    </div>
                                                `;
                                            }
                                            
                                            const loading = document.getElementById('loading');
                                            if (loading) {
                                                loading.classList.remove('active');
                                            }
                                            const generateBtn = document.getElementById('generateBtn');
                                            if (generateBtn) {
                                                generateBtn.disabled = false;
                                                generateBtn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
                                            }
                                        } else {
                                            // è®°å½•å¤ªæ—§ï¼Œä»»åŠ¡å¯èƒ½çœŸçš„ä¸å­˜åœ¨
                                            console.log('ä»»åŠ¡ä¸å­˜åœ¨ä¸”æ²¡æœ‰æœ€è¿‘çš„ç”Ÿæˆè®°å½•');
                                            clearInterval(statusPollingInterval);
                                            statusPollingInterval = null;
                                        }
                                    } else {
                                        // æ²¡æœ‰è®°å½•ï¼Œä»»åŠ¡å¯èƒ½çœŸçš„ä¸å­˜åœ¨
                                        console.log('ä»»åŠ¡ä¸å­˜åœ¨ä¸”æ²¡æœ‰ç”Ÿæˆè®°å½•');
                                        clearInterval(statusPollingInterval);
                                        statusPollingInterval = null;
                                    }
                                })
                                .catch(err => {
                                    console.error('æŸ¥è¯¢ç”Ÿæˆè®°å½•å¤±è´¥:', err);
                                    // å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œç»§ç»­è½®è¯¢ä¸€æ®µæ—¶é—´
                                });
                        } else {
                            // ä»»åŠ¡æ—¶é—´å¤ªä¹…ï¼Œåœæ­¢è½®è¯¢
                            console.log('ä»»åŠ¡ä¸å­˜åœ¨ä¸”æ—¶é—´è¿‡ä¹…ï¼Œåœæ­¢è½®è¯¢');
                            clearInterval(statusPollingInterval);
                            statusPollingInterval = null;
                        }
                    }
                } catch (error) {
                    console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                }
            }, 1000); // æ¯1ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼ˆåŠ å¿«æ£€æµ‹é€Ÿåº¦ï¼‰
        }
        
        // è·å–å½“å‰ç”¨æˆ·åï¼ˆä»é¡µé¢ä¸­è·å–ï¼‰
        function getCurrentUsername() {
            const usernameElement = document.querySelector('.username');
            return usernameElement ? usernameElement.textContent.trim() : null;
        }
        
        // æ›´æ–°è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
        function updateDebugInfo(message, taskId) {
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            if (debugInfo && debugContent) {
                debugInfo.style.display = 'block';
                const time = new Date().toLocaleTimeString();
                debugContent.innerHTML = `
                    <div>${time}</div>
                    <div>${message}</div>
                    <div>ä»»åŠ¡ID: ${taskId || 'æ— '}</div>
                `;
                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    if (debugInfo) {
                        debugInfo.style.display = 'none';
                    }
                }, 3000);
            }
        }
        
        // æ¢å¤ä»»åŠ¡çŠ¶æ€çš„å‡½æ•°
        function restoreGenerationState() {
            const savedState = localStorage.getItem('singleGenerationState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    const currentUsername = getCurrentUsername();
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åŒ¹é…
                    if (state.username && state.username !== currentUsername) {
                        console.log('æ£€æµ‹åˆ°ä¸åŒç”¨æˆ·çš„ä»»åŠ¡çŠ¶æ€ï¼Œæ¸…é™¤æ—§çŠ¶æ€');
                        localStorage.removeItem('singleGenerationState');
                        return false;
                    }
                    
                    const elapsed = Date.now() - state.startTime;
                    
                    // å¦‚æœæ˜¯è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼ˆ30åˆ†é’Ÿå†…ï¼‰
                    if ((state.status === 'generating' || state.pending) && elapsed < 30 * 60 * 1000) {
                        // å¦‚æœæœ‰ä»»åŠ¡IDï¼Œç›´æ¥æ¢å¤è½®è¯¢
                        if (state.taskId) {
                            currentTaskId = state.taskId;
                        const loading = document.getElementById('loading');
                            if (loading) {
                        loading.classList.add('active');
                            }
                            const generateBtn = document.getElementById('generateBtn');
                            if (generateBtn) {
                                generateBtn.disabled = true;
                                generateBtn.textContent = 'ç”Ÿæˆä¸­...';
                            }
                            
                            // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                            startStatusPolling(state.taskId);
                            console.log('å·²æ¢å¤å•å›¾ç”Ÿæˆä»»åŠ¡:', state.taskId);
                            return true;
                        } 
                        // å¦‚æœæ²¡æœ‰ä»»åŠ¡IDä½†æ˜¯æœ‰pendingæ ‡è®°ï¼Œè¯´æ˜è¯·æ±‚å¯èƒ½è¿˜åœ¨è¿›è¡Œä¸­
                        else if (state.pending) {
                            const loading = document.getElementById('loading');
                            if (loading) {
                                loading.classList.add('active');
                            }
                            const generateBtn = document.getElementById('generateBtn');
                            if (generateBtn) {
                                generateBtn.disabled = true;
                                generateBtn.textContent = 'ç”Ÿæˆä¸­...';
                            }
                            
                            // å°è¯•è½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼ˆé€šè¿‡æ£€æŸ¥æœ€è¿‘çš„ä»»åŠ¡ï¼‰
                            console.log('âš ï¸ æ£€æµ‹åˆ°å¾…å¤„ç†ä»»åŠ¡ï¼Œç­‰å¾…ä»»åŠ¡ID...');
                            updateDebugInfo('â³ ç­‰å¾…ä»»åŠ¡ID...', null);
                            
                            // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤šæ£€æŸ¥30æ¬¡ï¼ˆ1åˆ†é’Ÿï¼‰
                            let checkCount = 0;
                            const checkInterval = setInterval(() => {
                                checkCount++;
                                const currentState = localStorage.getItem('singleGenerationState');
                                if (currentState) {
                                    try {
                                        const current = JSON.parse(currentState);
                                        if (current.taskId) {
                                            clearInterval(checkInterval);
                                            currentTaskId = current.taskId;
                                            console.log('âœ… æ£€æµ‹åˆ°ä»»åŠ¡IDï¼Œå¼€å§‹è½®è¯¢:', current.taskId);
                                            updateDebugInfo('âœ… æ£€æµ‹åˆ°ä»»åŠ¡ID', current.taskId);
                                            startStatusPolling(current.taskId);
                                            return;
                                        }
                                        // å¦‚æœçŠ¶æ€ä¸å†æ˜¯pendingï¼Œè¯´æ˜å¯èƒ½å·²å®Œæˆæˆ–å¤±è´¥
                                        if (!current.pending && current.status !== 'generating') {
                                            clearInterval(checkInterval);
                                            console.log('ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°ï¼Œä¸å†æ˜¯pending:', current.status);
                                            if (current.status === 'completed') {
                                                updateDebugInfo('âœ… ä»»åŠ¡å·²å®Œæˆ', current.taskId);
                                            } else if (current.status === 'failed') {
                                                updateDebugInfo('âŒ ä»»åŠ¡å¤±è´¥', current.taskId);
                                            }
                                            return;
                                        }
                                    } catch (e) {
                                        console.error('è§£æçŠ¶æ€å¤±è´¥:', e);
                                    }
                                }
                                if (checkCount >= 30) {
                                    clearInterval(checkInterval);
                                    console.log('âŒ ç­‰å¾…ä»»åŠ¡IDè¶…æ—¶ï¼ˆ1åˆ†é’Ÿï¼‰');
                                    updateDebugInfo('âŒ ç­‰å¾…è¶…æ—¶', null);
                                    // æ¸…é™¤pendingçŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·é‡æ–°ç”Ÿæˆ
                                    if (loading) {
                                        loading.classList.remove('active');
                                    }
                                    if (generateBtn) {
                                        generateBtn.disabled = false;
                                        generateBtn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
                                    }
                                }
                            }, 2000); // æ”¹ä¸º2ç§’æ£€æŸ¥ä¸€æ¬¡
                            return true;
                        }
                    }
                    // å¦‚æœæ˜¯å·²å®Œæˆçš„ä»»åŠ¡ï¼Œæ¢å¤æ˜¾ç¤ºç»“æœ
                    else if (state.status === 'completed' && state.result) {
                        const resultImages = document.getElementById('resultImages');
                        if (resultImages && !resultImages.hasChildNodes()) {
                        displayResults(state.result);
                        }
                        return true;
                    }
                } catch (e) {
                    console.error('æ¢å¤ç”ŸæˆçŠ¶æ€å¤±è´¥:', e);
                }
            }
            return false;
        }
        
        // é¡µé¢åŠ è½½æ—¶ï¼Œå…ˆæ£€æŸ¥å¹¶æ¸…é™¤ä¸åŒ¹é…ç”¨æˆ·çš„ä»»åŠ¡çŠ¶æ€å’Œè¡¨å•æ•°æ®
        window.addEventListener('load', function() {
            const currentUsername = getCurrentUsername();
            
            // æ£€æŸ¥å¹¶æ¸…é™¤ä¸åŒ¹é…ç”¨æˆ·çš„ä»»åŠ¡çŠ¶æ€
            const savedState = localStorage.getItem('singleGenerationState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.username && state.username !== currentUsername) {
                        console.log('æ£€æµ‹åˆ°ä¸åŒç”¨æˆ·çš„ä»»åŠ¡çŠ¶æ€ï¼Œæ¸…é™¤æ—§çŠ¶æ€');
                        localStorage.removeItem('singleGenerationState');
                    } else if (state.pending && !state.username) {
                        // å¦‚æœçŠ¶æ€æ˜¯pendingä½†æ²¡æœ‰ç”¨æˆ·åï¼Œå¯èƒ½æ˜¯æ—§æ•°æ®ï¼Œæ¸…é™¤å®ƒ
                        console.log('æ£€æµ‹åˆ°æ—§çš„pendingçŠ¶æ€ï¼ˆæ— ç”¨æˆ·åï¼‰ï¼Œæ¸…é™¤å®ƒ');
                        localStorage.removeItem('singleGenerationState');
                    }
                } catch (e) {
                    console.error('è§£æä¿å­˜çš„çŠ¶æ€å¤±è´¥:', e);
                    localStorage.removeItem('singleGenerationState');
                }
            }
            
            // æ£€æŸ¥å¹¶æ¸…é™¤ä¸åŒ¹é…ç”¨æˆ·çš„è¡¨å•æ•°æ®
            const savedFormData = localStorage.getItem('indexFormData');
            if (savedFormData) {
                try {
                    const formData = JSON.parse(savedFormData);
                    if (formData.username && formData.username !== currentUsername) {
                        console.log('æ£€æµ‹åˆ°ä¸åŒç”¨æˆ·çš„è¡¨å•æ•°æ®ï¼Œæ¸…é™¤æ—§æ•°æ®');
                        localStorage.removeItem('indexFormData');
                    }
                } catch (e) {
                    console.error('è§£æè¡¨å•æ•°æ®å¤±è´¥:', e);
                    localStorage.removeItem('indexFormData');
                }
            }
            
            // æ¢å¤è¡¨å•æ•°æ®ï¼ˆåœ¨æ¢å¤ä»»åŠ¡çŠ¶æ€ä¹‹å‰ï¼‰
            loadFormData();
            
            // ç„¶åæ¢å¤ä»»åŠ¡çŠ¶æ€
            restoreGenerationState();
        });
        
        // ä½¿ç”¨ pageshow äº‹ä»¶ç¡®ä¿ä»ç¼“å­˜æ¢å¤æ—¶ä¹Ÿèƒ½æ¢å¤çŠ¶æ€
        window.addEventListener('pageshow', function(event) {
            // event.persisted ä¸º true è¡¨ç¤ºé¡µé¢æ˜¯ä»ç¼“å­˜ä¸­æ¢å¤çš„
            if (event.persisted) {
                console.log('é¡µé¢ä»ç¼“å­˜æ¢å¤ï¼Œæ£€æŸ¥ä»»åŠ¡çŠ¶æ€...');
                restoreGenerationState();
            }
        });
        
        // é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€
        window.addEventListener('beforeunload', function() {
            if (currentGenerationState) {
                // ä¿å­˜å½“å‰çŠ¶æ€ï¼ŒåŒ…æ‹¬ä»»åŠ¡ID
                if (currentTaskId) {
                    currentGenerationState.taskId = currentTaskId;
                }
                localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
            }
        });
        
        // ç›‘å¬æ‰€æœ‰å¯¼èˆªäº‹ä»¶ï¼Œåœ¨åˆ‡æ¢å‰ä¿å­˜çŠ¶æ€
        document.addEventListener('click', function(e) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å¯¼èˆªé“¾æ¥
            const link = e.target.closest('a');
            if (link && link.href && !link.href.startsWith('javascript:') && !link.href.startsWith('#')) {
                // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿çŠ¶æ€å·²æ›´æ–°
                setTimeout(() => {
                    if (currentGenerationState) {
                        if (currentTaskId) {
                            currentGenerationState.taskId = currentTaskId;
                        }
                        localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                    }
                }, 100);
            }
        });
        
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const errorMessage = document.getElementById('errorMessage');
            const loading = document.getElementById('loading');
            const resultImages = document.getElementById('resultImages');
            const generateBtn = document.getElementById('generateBtn');
            
            // å¼€å§‹æ–°çš„ç”Ÿæˆï¼Œæ¸…ç©ºä¹‹å‰çš„ç»“æœå’ŒçŠ¶æ€
            errorMessage.classList.remove('active');
            loading.classList.add('active');
            resultImages.innerHTML = '';
            generateBtn.disabled = true;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            
            // ä¿å­˜ç”ŸæˆçŠ¶æ€ä¸ºè¿›è¡Œä¸­ï¼ˆåŒ…å«ç”¨æˆ·åï¼‰
            const currentUsername = getCurrentUsername();
            currentGenerationState = {
                status: 'generating',
                startTime: Date.now(),
                username: currentUsername  // ä¿å­˜ç”¨æˆ·åç”¨äºéªŒè¯
            };
            localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
            
            const formData = new FormData(this);
            
            // æ·»åŠ æ‰‹åŠ¨ä¸Šä¼ çš„æ–‡ä»¶
            selectedFiles.forEach(file => {
                formData.append('images', file);
            });
            
            // æ·»åŠ é€‰ä¸­çš„ç¤ºä¾‹å›¾ URL
            selectedSampleImages.forEach(img => {
                formData.append('sample_image_urls', img.url);
            });
            
            try {
                // åœ¨å‘é€è¯·æ±‚å‰ï¼Œå…ˆä¿å­˜ä¸€ä¸ªå¾…å¤„ç†çŠ¶æ€ï¼Œå¹¶ç«‹å³ä¿å­˜åˆ° localStorage
                currentGenerationState.status = 'generating';
                currentGenerationState.pending = true; // æ ‡è®°ä¸ºå¾…å¤„ç†
                localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                
                // ä½¿ç”¨ keepalive é€‰é¡¹ï¼Œç¡®ä¿å³ä½¿é¡µé¢å…³é—­è¯·æ±‚ä¹Ÿä¼šå®Œæˆ
                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData,
                    keepalive: true  // å…³é”®ï¼šä¿æŒè¯·æ±‚æ´»è·ƒ
                });
                
                const data = await response.json();
                
                if (data.error) {
                    errorMessage.textContent = data.error;
                    errorMessage.classList.add('active');
                    // æ›´æ–°çŠ¶æ€ä¸ºå¤±è´¥ï¼ˆåŒ…å«ç”¨æˆ·åï¼‰
                    const currentUsername = getCurrentUsername();
                    currentGenerationState = {
                        status: 'failed',
                        error: data.error,
                        startTime: currentGenerationState.startTime,
                        taskId: data.task_id || currentTaskId,
                        username: currentUsername
                    };
                    delete currentGenerationState.pending;
                    localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                } else if (data.success) {
                    // æ— è®ºæ˜¯å¦æœ‰å›¾ç‰‡ï¼Œéƒ½å…ˆä¿å­˜task_idï¼ˆå…³é”®ä¿®å¤ï¼‰
                    if (data.task_id) {
                        currentTaskId = data.task_id;
                        console.log('âœ… æ”¶åˆ°ä»»åŠ¡ID:', data.task_id);
                    }
                    
                    // å¦‚æœå“åº”æˆåŠŸä¸”åŒ…å«å›¾ç‰‡ï¼Œè¯´æ˜ä»»åŠ¡å·²å®Œæˆï¼ˆåŒæ­¥è¿”å›ç»“æœï¼‰
                    if (data.images && data.images.length > 0) {
                        // åœæ­¢è½®è¯¢ï¼ˆå¦‚æœæ­£åœ¨è½®è¯¢ï¼‰
                        if (statusPollingInterval) {
                            clearInterval(statusPollingInterval);
                            statusPollingInterval = null;
                        }
                        
                        // æ˜¾ç¤ºç»“æœ
                    displayResults(data);
                        
                        // ä¿å­˜å®ŒæˆçŠ¶æ€å’Œç»“æœï¼ˆåŒ…å«ç”¨æˆ·åå’Œtask_idï¼‰
                        const currentUsername = getCurrentUsername();
                    currentGenerationState = {
                        status: 'completed',
                        result: data,
                            startTime: currentGenerationState.startTime,
                            taskId: data.task_id || currentTaskId,
                            username: currentUsername
                    };
                        delete currentGenerationState.pending; // æ¸…é™¤pendingæ ‡è®°
                    localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                    
                        // ç«‹å³æ›´æ–°UIï¼Œç¡®ä¿ç”¨æˆ·å¯ä»¥ç»§ç»­æ“ä½œ
                        loading.classList.remove('active');
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
                        
                        console.log('âœ… å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼Œä»»åŠ¡å·²å®Œæˆï¼Œä»»åŠ¡ID:', data.task_id || currentTaskId);
                    } else if (data.task_id) {
                        // å¦‚æœè¿”å›äº†task_idä½†æ²¡æœ‰å›¾ç‰‡ï¼Œè¯´æ˜æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Œå¼€å§‹è½®è¯¢
                        currentGenerationState.taskId = data.task_id;
                        currentGenerationState.status = 'generating';
                        delete currentGenerationState.pending;
                        // ç«‹å³ä¿å­˜åˆ° localStorage
                        localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                        // ç«‹å³å¼€å§‹è½®è¯¢ï¼ˆæ¯1ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼ŒåŠ å¿«æ£€æµ‹é€Ÿåº¦ï¼‰
                        startStatusPolling(data.task_id);
                        console.log('ğŸ”„ å¼‚æ­¥ä»»åŠ¡ï¼Œå¼€å§‹è½®è¯¢ï¼Œä»»åŠ¡ID:', data.task_id);
                    } else {
                        // å¦‚æœæ²¡æœ‰task_idä¹Ÿæ²¡æœ‰imagesï¼Œå¯èƒ½æ˜¯å¼‚å¸¸æƒ…å†µ
                        console.warn('âš ï¸ å“åº”æˆåŠŸä½†æ²¡æœ‰task_idå’Œimages:', data);
                        delete currentGenerationState.pending;
                        localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                    }
                }
            } catch (error) {
                errorMessage.textContent = 'ç”Ÿæˆå¤±è´¥: ' + error.message;
                errorMessage.classList.add('active');
                // æ›´æ–°çŠ¶æ€ä¸ºå¤±è´¥ï¼ˆåŒ…å«ç”¨æˆ·åï¼‰
                const currentUsername = getCurrentUsername();
                currentGenerationState = {
                    status: 'failed',
                    error: error.message,
                    startTime: currentGenerationState ? currentGenerationState.startTime : Date.now(),
                    taskId: currentTaskId,
                    username: currentUsername
                };
                delete currentGenerationState.pending;
                localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
            } finally {
                loading.classList.remove('active');
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
            }
        });
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œæç¤ºç”¨æˆ·
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                const loading = document.getElementById('loading');
                if (loading && loading.classList.contains('active')) {
                    console.log('é¡µé¢å·²åˆ‡æ¢ï¼Œä½†ç”Ÿæˆä»»åŠ¡å°†ç»§ç»­åœ¨åå°æ‰§è¡Œ');
                    // ä¿å­˜å½“å‰çŠ¶æ€ï¼ˆç¡®ä¿ä»»åŠ¡IDå·²ä¿å­˜ï¼‰
                    if (currentGenerationState) {
                        if (currentTaskId) {
                            currentGenerationState.taskId = currentTaskId;
                        }
                        localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
                    }
                }
            } else {
                // é¡µé¢è¿”å›æ—¶ï¼Œæ£€æŸ¥å¹¶æ¢å¤çŠ¶æ€
                console.log('é¡µé¢å¯è§ï¼Œæ£€æŸ¥ä»»åŠ¡çŠ¶æ€...');
                restoreGenerationState();
            }
        });
        
        // å®šæœŸä¿å­˜çŠ¶æ€ï¼ˆæ¯5ç§’ï¼‰ï¼Œé˜²æ­¢çŠ¶æ€ä¸¢å¤±
        setInterval(function() {
            if (currentGenerationState && (currentGenerationState.status === 'generating' || currentGenerationState.pending)) {
                const currentUsername = getCurrentUsername();
                if (currentUsername) {
                    currentGenerationState.username = currentUsername;  // ç¡®ä¿ç”¨æˆ·åæ˜¯æœ€æ–°çš„
                }
                if (currentTaskId) {
                    currentGenerationState.taskId = currentTaskId;
                }
                localStorage.setItem('singleGenerationState', JSON.stringify(currentGenerationState));
            }
        }, 5000);
        
        function displayResults(data) {
            const resultImages = document.getElementById('resultImages');
            
            data.images.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'result-image';
                div.innerHTML = `
                    <img src="${img.url}" alt="ç”Ÿæˆçš„å›¾ç‰‡ ${index + 1}">
                    <div class="result-info">
                        <p><strong>æ–‡ä»¶å:</strong> ${img.filename}</p>
                        <p><strong>ç§å­å€¼:</strong> ${img.seed}</p>
                        <p><strong>å°ºå¯¸:</strong> ${data.params.width} Ã— ${data.params.height}</p>
                        <a href="${img.url}" download="${img.filename}">
                            <button class="download-btn">â¬‡ï¸ ä¸‹è½½å›¾ç‰‡</button>
                        </a>
                        <button class="download-btn" onclick="addToPersonLibrary('${img.url}', '${img.filename}')">â• æ·»åŠ åˆ°äººç‰©åº“</button>
                        <button class="download-btn" onclick="addToSceneLibrary('${img.url}', '${img.filename}')">â• æ·»åŠ åˆ°åœºæ™¯åº“</button>
                        <button class="download-btn" onclick="regenerateLast()">ğŸ” é‡æ–°ç”Ÿæˆ</button>
                    </div>
                `;
                resultImages.appendChild(div);
            });
            // ä¿å­˜æœ€åä¸€æ¬¡ç”Ÿæˆçš„å‚æ•°ï¼Œä¾¿äºé‡æ–°ç”Ÿæˆ
            try {
                const payload = buildLastGeneratePayload();
                localStorage.setItem('lastGenerationPayload', JSON.stringify(payload));
            } catch (e) { console.error('ä¿å­˜æœ€åç”Ÿæˆå‚æ•°å¤±è´¥', e); }
        }
        
        // æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.querySelector('.upload-area');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#e8eaff';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.backgroundColor = '#f8f9ff';
        });
        
        uploadArea.addEventListener('drop', (e) => {
                        // åœ¨æäº¤å‰ä¿å­˜æœ¬æ¬¡ç”Ÿæˆå‚æ•°ï¼ˆä¸åŒ…å«æœ¬åœ°æ–‡ä»¶ï¼‰
                        const payloadToSave = buildLastGeneratePayload();
                        localStorage.setItem('lastGenerationPayload', JSON.stringify(payloadToSave));
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f8f9ff';
            
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            
            if (selectedFiles.length + files.length > 4) {
                alert('æœ€å¤šåªèƒ½ä¸Šä¼  4 å¼ å›¾ç‰‡');
                return;
            }
            
            selectedFiles = selectedFiles.concat(files.slice(0, 4 - selectedFiles.length));
            updatePreview();
        });
        
        // ç¤ºä¾‹å›¾ç±»åˆ«ï¼ˆperson/sceneï¼‰
        let sampleCategory = 'person';

        

        function switchSampleCategory(cat) {
            sampleCategory = cat;
            document.getElementById('samplePersonBtn').classList.toggle('btn-primary', cat === 'person');
            document.getElementById('sampleSceneBtn').classList.toggle('btn-primary', cat === 'scene');
            loadSampleImages(cat);
        }

        // åŠ è½½ç¤ºä¾‹å›¾ç‰‡ï¼ˆæŒ‰ç±»åˆ«ï¼‰
        async function loadSampleImages(category) {
            const grid = document.getElementById('sampleImagesGrid');
            grid.innerHTML = '<div class="sample-images-loading">åŠ è½½ä¸­...</div>';
            try {
                const response = await fetch('/api/sample-images?category=' + encodeURIComponent(category));
                const data = await response.json();

                if (data.success && data.images.length > 0) {
                    sampleImages = data.images;
                    grid.innerHTML = '';
                    data.images.forEach((img, index) => {
                        const div = document.createElement('div');
                        div.className = 'sample-image-item';
                        div.onclick = () => toggleSampleImage(index);
                        div.innerHTML = `
                            <img src="${img.url}" alt="${img.filename}" title="${img.filename}">
                            <div class="sample-image-count"></div>
                        `;
                        grid.appendChild(div);
                    });
                } else {
                    grid.innerHTML = '<div class="sample-images-loading">ğŸ’­ æš‚æ— ç¤ºä¾‹å›¾ç‰‡</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ç¤ºä¾‹å›¾å¤±è´¥:', error);
                grid.innerHTML = '<div class="sample-images-loading">âŒ åŠ è½½å¤±è´¥</div>';
            }
        }

        // å°†ç”Ÿæˆå›¾ç‰‡æ·»åŠ åˆ°äººç‰©/ç´ æåº“
        async function addToPersonLibrary(url, filename) {
            try {
                const resp = await fetch('/api/add-to-person-library', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, filename: filename })
                });
                const data = await resp.json();
                    if (data.success) {
                    alert('å·²æ·»åŠ åˆ°äººç‰©åº“');
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        }

        // å°†ç”Ÿæˆå›¾ç‰‡æ·»åŠ åˆ°åœºæ™¯åº“
        async function addToSceneLibrary(url, filename) {
            try {
                const resp = await fetch('/api/add-to-scene-library', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, filename: filename })
                });
                const data = await resp.json();
                if (data.success) {
                    alert('å·²æ·»åŠ åˆ°åœºæ™¯åº“');
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        }
        
        // åˆ‡æ¢ç¤ºä¾‹å›¾é€‰æ‹©çŠ¶æ€
        function toggleSampleImage(index) {
            const img = sampleImages[index];
            const existingIndex = selectedSampleImages.findIndex(s => s.url === img.url);
            
            if (existingIndex >= 0) {
                // å–æ¶ˆé€‰ä¸­
                selectedSampleImages.splice(existingIndex, 1);
            } else {
                // æ£€æŸ¥æ€»æ•°é™åˆ¶ï¼ˆæ‰‹åŠ¨ä¸Šä¼  + ç¤ºä¾‹å›¾ <= 4ï¼‰
                const totalSelected = selectedFiles.length + selectedSampleImages.length;
                if (totalSelected >= 4) {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹© 4 å¼ å›¾ç‰‡ï¼ˆåŒ…æ‹¬æ‰‹åŠ¨ä¸Šä¼ å’Œç¤ºä¾‹å›¾ï¼‰');
                    return;
                }
                selectedSampleImages.push(img);
            }
            
            updateSampleImagesUI();
        }
        
        // æ›´æ–°ç¤ºä¾‹å›¾ UI
        function updateSampleImagesUI() {
            const grid = document.getElementById('sampleImagesGrid');
            const items = grid.querySelectorAll('.sample-image-item');
            
            items.forEach((item, index) => {
                const img = sampleImages[index];
                const selectedIndex = selectedSampleImages.findIndex(s => s.url === img.url);
                
                if (selectedIndex >= 0) {
                    item.classList.add('selected');
                    const countDiv = item.querySelector('.sample-image-count');
                    countDiv.textContent = selectedIndex + 1;
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–ç¤ºä¾‹å›¾å’Œæ¢å¤è¡¨å•æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç±»åˆ«æŒ‰é’®
            const btnP = document.getElementById('samplePersonBtn');
            const btnS = document.getElementById('sampleSceneBtn');
            if (btnP && btnS) {
                btnP.addEventListener('click', () => switchSampleCategory('person'));
                btnS.addEventListener('click', () => switchSampleCategory('scene'));
            }
            // é»˜è®¤åŠ è½½
            loadSampleImages(sampleCategory);
            // æ³¨æ„ï¼šloadFormData() åœ¨ window.load äº‹ä»¶ä¸­è°ƒç”¨ï¼Œç¡®ä¿ç”¨æˆ·åå·²åŠ è½½å¹¶æ£€æŸ¥ç”¨æˆ·åŒ¹é…
            setupAutoSave();
        });
    </script>
</body>
</html>
