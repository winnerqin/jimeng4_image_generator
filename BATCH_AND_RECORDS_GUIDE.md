# 批量生成与记录管理功能说明

## 🎉 新增功能概览

本次更新为AI图片生成器添加了完整的批量生成和历史记录管理功能，让您可以更高效地管理图片生成任务。

## ✨ 主要功能

### 1. 📦 批量生成页面

**访问地址:** http://localhost:5000/batch

**核心功能:**
- ✅ Excel导入导出批量任务
- ✅ 在线表格编辑（添加/删除行）
- ✅ 为每行任务选择参考示例图（最多4张）
- ✅ 单次生成或批量生成
- ✅ 实时进度显示和日志输出
- ✅ 下载Excel模板

**表格字段:**
| 字段 | 说明 | 必填 |
|------|------|------|
| 提示词 | 描述想要生成的图片内容 | ✓ |
| 负面提示词 | 描述不想要的内容 | ✗ |
| 图片比例 | 1:1, 2:3, 3:2, 3:4, 4:3, 16:9, 9:16 | ✓ |
| 分辨率 | 1K, 2K, 4K | ✓ |
| 参考示例图 | 从OSS选择示例图（0-4张） | ✗ |
| 生成数量 | 每个任务生成的图片数量 (1-10) | ✓ |
| 文件名 | 输出文件名前缀 | ✓ |

**使用流程:**

1. **导入Excel任务列表**
   ```
   点击"📂 导入 Excel" → 选择Excel文件 → 自动填充表格
   ```

2. **手动编辑任务**
   ```
   点击"➕ 添加一行" → 填写任务参数 → 选择示例图 → 重复添加
   ```

3. **选择参考示例图**
   ```
   点击"选择 (N)" 按钮 → 在弹窗中选择图片 → 点击"✓ 确认选择"
   ```

4. **开始批量生成**
   ```
   点击"🚀 开始批量生成" → 确认 → 查看实时进度
   ```

5. **导出任务列表**
   ```
   点击"💾 导出当前表格" → 下载Excel文件
   ```

**Excel模板格式:**
```
提示词 | 负面提示词 | 图片比例 | 分辨率 | 生成数量 | 文件名
一只可爱的猫咪 | 模糊，低质量 | 1:1 | 2k | 1 | cat_01
美丽的风景画 | | 16:9 | 2k | 2 | landscape_01
```

### 2. 📊 生成记录页面

**访问地址:** http://localhost:5000/records

**核心功能:**
- ✅ 查看所有历史生成记录
- ✅ 搜索提示词过滤记录
- ✅ 图片缩略图预览
- ✅ 点击缩略图放大查看（支持键盘导航）
- ✅ 查看参考示例图
- ✅ 下载生成的图片
- ✅ 删除记录
- ✅ 分页浏览

**记录信息:**
| 字段 | 说明 |
|------|------|
| ID | 记录唯一标识 |
| 生成时间 | 图片生成的时间戳 |
| 提示词 | 使用的提示词 |
| 图片比例 | 图片的宽高比 |
| 参考示例图 | 使用的示例图缩略图 |
| 分辨率 | 图片尺寸（宽×高）|
| 图片预览 | 生成图片的缩略图 |
| 操作 | 下载、删除按钮 |

**使用技巧:**

1. **搜索记录**
   ```
   在搜索框输入关键词 → 按Enter或点击🔍 → 显示匹配结果
   ```

2. **放大查看图片**
   ```
   点击缩略图 → 查看大图 → 使用左右箭头切换 → 按ESC关闭
   ```

3. **键盘快捷键**
   - `←` 上一张图片
   - `→` 下一张图片
   - `ESC` 关闭放大查看

4. **下载图片**
   ```
   点击"⬇️ 下载"按钮 → 保存到本地
   ```

5. **删除记录**
   ```
   点击"🗑️ 删除"按钮 → 确认删除
   ```

### 3. 🎨 单图生成页面（已升级）

**访问地址:** http://localhost:5000/

**新增功能:**
- ✅ 导航栏快速切换页面
- ✅ 自动保存生成记录到数据库
- ✅ 从OSS选择示例图（新功能）
- ✅ 所有生成都会记录在"生成记录"页面

## 🗄️ 数据库存储

**数据库文件:** `generation_records.db` (SQLite)

**记录字段:**
```sql
- id: 自增主键
- created_at: 生成时间
- prompt: 提示词
- negative_prompt: 负面提示词
- aspect_ratio: 图片比例
- resolution: 分辨率
- width, height: 图片尺寸
- num_images: 生成数量
- seed: 随机种子
- steps: 采样步数
- sample_images: 参考示例图JSON
- image_path: 图片路径
- filename: 文件名
- batch_id: 批次ID（批量生成时）
- status: 生成状态
```

## 🔄 工作流程示例

### 场景1：批量生成多个角色

```
1. 准备Excel表格：
   角色A | 负面提示词 | 1:1 | 2k | 1 | character_A
   角色B | 负面提示词 | 1:1 | 2k | 1 | character_B
   角色C | 负面提示词 | 1:1 | 2k | 1 | character_C

2. 导入Excel → 批量生成

3. 前往"生成记录"查看结果 → 下载满意的图片
```

### 场景2：使用示例图优化风格

```
1. 进入"批量生成"页面

2. 添加任务 → 选择风格参考图

3. 输入提示词："在森林中的小木屋，温暖的灯光"

4. 批量生成多个变体

5. 在"生成记录"中对比效果
```

### 场景3：查找历史生成

```
1. 进入"生成记录"页面

2. 搜索框输入"猫咪"

3. 查看所有包含"猫咪"的生成记录

4. 点击缩略图放大查看

5. 下载喜欢的图片
```

## 📝 API接口

### 批量生成API
```
POST /api/batch-generate
Content-Type: application/json

{
  "prompt": "提示词",
  "negative_prompt": "负面提示词",
  "aspect_ratio": "1:1",
  "resolution": "2k",
  "sample_images": [
    {"url": "https://...", "filename": "..."}
  ],
  "num_images": 1,
  "filename": "output"
}

Response:
{
  "success": true,
  "images": [...],
  "batch_id": "uuid"
}
```

### 获取记录API
```
GET /api/records?limit=20&offset=0&search=关键词

Response:
{
  "success": true,
  "records": [...],
  "total": 100
}
```

### 删除记录API
```
DELETE /api/records/<record_id>

Response:
{
  "success": true
}
```

## 🎯 性能优化建议

1. **批量生成大任务**
   - 建议单批次不超过50个任务
   - 大批量任务可以分多次执行

2. **数据库维护**
   - 定期清理无用记录
   - 备份 `generation_records.db` 文件

3. **图片存储**
   - `output/` 目录会累积大量图片
   - 建议定期清理或移动到归档目录

## 🐛 故障排查

### 批量生成失败
**问题:** 点击批量生成后无响应  
**解决:** 
1. 检查每一行是否有提示词
2. 查看浏览器控制台错误
3. 检查Flask应用日志

### 记录页面空白
**问题:** 打开记录页面显示"暂无记录"  
**解决:**
1. 确认已生成过图片
2. 检查 `generation_records.db` 是否存在
3. 重启Flask应用

### 图片无法显示
**问题:** 缩略图显示"加载失败"  
**解决:**
1. 确认图片文件在 `output/` 目录
2. 检查文件权限
3. 确认文件名与数据库记录匹配

### Excel导入失败
**问题:** 导入Excel后表格为空  
**解决:**
1. 确认Excel格式正确（使用模板）
2. 检查表头名称是否匹配
3. 确认浏览器支持文件读取API

## 🔗 相关文件

```
jimeng4_image_generator/
├── web_app.py              # Flask应用（新增路由）
├── database.py             # 数据库模型（新文件）
├── generation_records.db   # SQLite数据库（自动生成）
├── templates/
│   ├── index.html          # 单图生成页面（已更新）
│   ├── batch.html          # 批量生成页面（新文件）
│   └── records.html        # 生成记录页面（新文件）
└── output/                 # 生成的图片存储目录
```

## 🚀 快速开始

```bash
# 1. 确保虚拟环境已激活
.\.venv\Scripts\Activate.ps1

# 2. 启动Flask应用（会自动创建数据库）
python web_app.py

# 3. 访问页面
#    单图生成: http://localhost:5000/
#    批量生成: http://localhost:5000/batch
#    生成记录: http://localhost:5000/records
```

## 🎊 总结

新版本的AI图片生成器提供了完整的批量生成和记录管理功能：

✅ **批量生成:** Excel导入、在线编辑、示例图选择、进度追踪  
✅ **记录管理:** 历史查看、搜索过滤、图片放大、快速下载  
✅ **数据持久化:** SQLite数据库存储所有生成记录  
✅ **用户体验:** 导航栏、实时反馈、键盘快捷键  

现在您可以更高效地管理和组织AI图片生成任务！🎨✨
