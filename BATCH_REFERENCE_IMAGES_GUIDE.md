# 批量生成参考图功能使用指南

## 📋 功能概述

批量生成页面现在支持两种方式添加参考图（示例图）：
1. **直接输入文件名** - 在"参考图"列的输入框中输入文件名，自动匹配OSS中的示例图
2. **手动选择** - 通过"选择"按钮从示例图库中选择

## 🎯 功能特点

### 1. 文本输入匹配
- 在表格的"参考图"列输入框中输入示例图文件名
- 支持多个文件名，使用以下任意分隔符：
  - 逗号 `,`
  - 中文逗号 `，`
  - 分号 `;`
  - 空格
- 自动模糊匹配OSS中 `ai-images/sample/` 目录下的图片
- 实时更新，输入后自动显示匹配结果

### 2. Excel批量导入
- Excel模板中新增"参考图"列
- 在Excel中填写示例图文件名（支持多个，逗号分隔）
- 导入时自动匹配OSS中的示例图
- 兼容旧版"示例图文件名"列

### 3. 手动选择
- 点击"选择 (n)"按钮打开示例图选择器
- 可视化浏览所有可用示例图
- 选择后自动同步到文本输入框

### 4. 双向同步
- 通过文本输入框添加的图片会显示在下方标签中
- 通过选择器添加的图片会自动填充到文本输入框
- 删除标签会同步更新文本输入框

## 📝 使用方法

### 方法一：直接输入文件名

1. 在批量生成表格中，找到"参考图"列
2. 在输入框中输入文件名（不需要扩展名）
3. 例如：
   ```
   sdk_generated_20251130, example_image
   ```
4. 系统自动匹配并显示已选图片

### 方法二：Excel批量导入

1. 下载Excel模板
2. 在"参考图"列填写文件名：
   ```
   参考图
   --------
   sdk_generated_20251130, example_image
   landscape_photo
   cat_image, dog_image, bird_image
   ```
3. 导入Excel，系统自动匹配示例图
4. 导入成功后显示匹配统计：
   ```
   成功导入 X 行数据，匹配 Y 个示例图
   ```

### 方法三：手动选择

1. 点击"选择 (0)"按钮
2. 在弹出的示例图选择器中浏览图片
3. 点击图片选择（最多4张）
4. 点击"确认选择"
5. 选择的文件名自动填充到输入框

## 🔍 匹配规则

系统使用智能模糊匹配算法：

### 匹配逻辑
- **包含匹配**：输入的文件名是图片文件名的一部分
- **反向匹配**：图片文件名（去除扩展名）包含输入的文件名
- **去重处理**：自动过滤重复的图片
- **数量限制**：最多匹配4张图片

### 示例
假设OSS中有以下图片：
```
sdk_generated_20251130.jpg
sdk_generated_20251130_02.png
landscape_photo_hd.jpg
cat_cute_01.jpg
```

输入文件名：
- `sdk_generated` → 匹配：sdk_generated_20251130.jpg, sdk_generated_20251130_02.png
- `landscape` → 匹配：landscape_photo_hd.jpg
- `cat_cute` → 匹配：cat_cute_01.jpg
- `20251130` → 匹配：sdk_generated_20251130.jpg, sdk_generated_20251130_02.png

## 📊 Excel模板格式

### 新版模板（推荐）
```
| 提示词 | 负面提示词 | 图片比例 | 分辨率 | 参考图 | 生成数量 | 文件名 |
|--------|-----------|---------|--------|--------|---------|---------|
| 一只可爱的猫咪 | 模糊，低质量 | 1:1 | 2k | sdk_generated_20251130, example_image | 1 | cat_01 |
| 美丽的风景画 | | 16:9 | 2k | | 2 | landscape_01 |
```

### 兼容旧版
系统仍然支持旧的"示例图文件名"列，会自动转换为"参考图"。

## 💡 使用技巧

### 1. 快速匹配
- 只输入文件名关键部分即可，无需完整文件名
- 例如：输入 `2025` 可以匹配所有包含2025的文件

### 2. 批量操作
- 在Excel中一次性填写所有参考图
- 使用逗号分隔多个文件名
- 导入后可以继续手动调整

### 3. 预览确认
- 匹配的图片会以标签形式显示
- 鼠标悬停在标签上可查看完整文件名
- 点击标签上的 ✕ 可删除

### 4. 状态保持
- 表格内容会自动保存到localStorage
- 刷新页面或切换页面后数据不丢失
- 包括参考图输入框的内容

## 🎨 界面说明

### 参考图列布局
```
┌─────────────────────────────┐
│ [输入文件名，逗号分隔]        │ ← 文本输入框
├─────────────────────────────┤
│ [选择 (2)] 按钮              │ ← 手动选择器
├─────────────────────────────┤
│ [img1...] [img2...] [✕]     │ ← 已选图片标签
└─────────────────────────────┘
```

### 视觉提示
- **输入框焦点**：蓝色边框高亮
- **选择按钮**：显示当前已选数量
- **图片标签**：浅蓝色背景，带删除按钮

## ⚙️ 技术实现

### 前端功能
- `updateRefImages(rowIndex, text)` - 处理文本输入，自动匹配
- `confirmSampleSelection()` - 手动选择后同步文本
- `removeSampleFromRow(rowIndex, sampleIndex)` - 删除标签同步文本

### 匹配算法
```javascript
// 模糊匹配逻辑
const matched = sampleImages.find(img => 
    img.filename.includes(trimmedName) || 
    trimmedName.includes(img.filename.split('.')[0])
);
```

### 状态同步
- 文本输入 → 自动匹配 → 更新标签
- 手动选择 → 更新文本 → 更新标签
- 删除标签 → 更新文本 → 更新数组

## 🔄 数据流程

### 导入流程
```
Excel文件 → 读取"参考图"列 → 解析分隔符 → 匹配OSS图片 → 填充表格
```

### 导出流程
```
表格数据 → 提取ref_images_text → 导出到Excel"参考图"列
```

### 生成流程
```
表格数据 → sample_images数组 → API请求 → 生成图片
```

## 📝 注意事项

1. **文件名不区分大小写**
2. **最多选择4张参考图**
3. **确保OSS中存在对应的示例图**
4. **删除本地标签不会删除OSS中的文件**
5. **刷新页面前数据会自动保存**

## 🆘 常见问题

### Q: 输入文件名后没有匹配到图片？
A: 请检查：
- 文件名是否正确
- 示例图是否已上传到OSS的 `ai-images/sample/` 目录
- 可以到"示例图管理"页面查看可用图片列表

### Q: 导入Excel后匹配数量为0？
A: 可能原因：
- "参考图"列为空
- 文件名拼写错误
- OSS中没有对应的示例图

### Q: 如何查看OSS中有哪些示例图？
A: 访问"示例图管理"页面 (`/manage-samples`)，可以查看、上传、删除示例图。

### Q: 可以混合使用文本输入和手动选择吗？
A: 可以！两种方式会自动同步，选择哪种方式都可以。

## 🚀 最佳实践

1. **统一命名**：给示例图使用有意义的文件名，便于记忆和匹配
2. **分类管理**：使用前缀区分不同类型的示例图（如：cat_、landscape_）
3. **定期整理**：删除不再使用的示例图，保持列表整洁
4. **Excel模板**：保存常用的Excel模板，提高批量生成效率
5. **预先上传**：在批量生成前先上传好所有需要的示例图

## 📄 相关文档

- [批量生成功能指南](BATCH_AND_RECORDS_GUIDE.md)
- [示例图管理指南](SAMPLE_IMAGES_GUIDE.md)
- [功能更新说明](FEATURE_UPDATES.md)
